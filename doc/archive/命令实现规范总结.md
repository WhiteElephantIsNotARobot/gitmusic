## 一、核心工作流命令

### 1. `publish` 命令
**功能**：发布本地改动到库中
**核心行为**：
- 分析work目录下的文件，计算音频哈希
- 对比`metadata.jsonl`数据库
- 识别变更类型：`NEW`（新文件）、`MOD`（元数据不匹配）、`SAME`（未变更）
- **变更输出**：输出详细的字段级差异（git风格）
- 自动工作流：分析变更 → 打印预览并等待确认 → 压缩封面 → 校验哈希（失败终止命令） → 同步上传 → Git提交推送

**选项**：

- `--changed-only`：仅处理有变动的文件
- `--preview`：仅显示预览，不执行发布

**交互**：显示变更预览表格，询问确认后执行完整工作流

### 2. `checkout` 命令
**功能**：从缓存检出音频到工作目录
**核心行为**：

- 支持通过关键词搜索或`-m`（缺失项）过滤元数据
- 检出前检查work目录冲突，若存在未处理文件且无`-f`选项，则自动连锁（cli层）调用`publish --preview`并退出
- 从cache提取音频，嵌入最新元数据和封面，嵌入`METADATA_HASH`标签（与release一致），写回work目录

**选项**：
- `<query>`：搜索关键词（默认在所有字段搜索）
- `--missing <fields>`：按缺失字段过滤（如`cover,uslt,album,date`仅匹配缺失全部4个字段）
- `--force, -f`：强制覆盖work已有文件
- `--limit <n>`：限制处理数量
- `--search-field <field>`：仅在指定字段搜索，未使用此参数指定oid时从不在oid中搜索
- `--line <n>`：按行号过滤输出（逗号分隔，也可xx-xx表范围），提供短参数`-l`

### 3. `release` 命令
**功能**：生成成品库
**核心行为**：

- **增量生成**：默认增量，通过`METADATA_HASH`标签在metadata对应行计算来跳过未变动文件
- **前置操作**：生成前执行`git pull`
- **工作流**：同步缓存 → 校验哈希 → 生成成品
- **路径**：本地模式生成到`release`目录，服务器模式生成到`/srv/music/data/release`

**选项**：
- `--mode <local|server>`：运行模式（默认local）
- `--force, -f`：生成前清空目标目录
- `--line, -l <n>`：按行号生成，可xx-xx表范围（提供短选项）
- `--workers <n>`：并行线程数（默认1）

## 二、数据管理与维护命令

### 4. `sync` 命令
**功能**：同步本地与远程缓存
**核心行为**：
- 双向增量同步：对比本地与远程哈希
- 支持重试机制（指数退避）和超时控制
- **配置**：从`config.yaml`读取远程参数（user, host, retries, timeout）

**选项**：
- `--direction <upload|download|both>`：同步方向（默认both）
- `--dry-run`：仅显示差异，不执行同步
- `--timeout <n>`：单个文件超时时间
- `--workers <n>`：并行线程数

**别名**：
- `push` = `sync --direction=upload`
- `pull` = `sync --direction=download`

### 5. `verify` 命令
**功能**：校验文件哈希完整性
**核心行为**：
- 重新计算cache目录下文件的SHA256，确保与文件名一致（剔除后缀）
- 输出要匹配文件对应metadata条目（同时根据文件名和实际哈希），输出条目行号，匹配失败则输出文件名
- **`--mode release`模式**：与`metadata.jsonl`比对release目录成品在自定义标签中存储的元数据（jsonl中对应行）哈希

**选项**：
- `--mode <data|release>`：校验模式
- `--delete`：自动删除无法在metadata中匹配的，哈希错误的文件（移动到回收站）

### 6. `cleanup` 命令
**功能**：清理孤立文件
**核心行为**：

- 识别未被`metadata.jsonl`引用的孤立文件
- **双端清理**：支持同步清理本地和远端目录
- **不支持服务端运行**：仅在本地执行
- 默认仅输出待清理文件列表

**选项**：
- `--mode <local|server|both>`：清理模式
- `--confirm`：必须指定才执行删除

## 三、工具类命令

### 7. `download` 命令
**功能**：下载音频并更新库
**核心行为**：

- 调用`yt-dlp`从网易云下载音频，提取元数据
- **预览**：默认下载时预览元数据（除了`metadata.jsonl中`可存储的字段，还包括音轨元数据，如时长、比特率等）
- 捕获yt-dlp原始输出（脚本层）并转发（cli层）（用于显示下载进度）
- **自动工作流**：下载 → 压缩封面 → 校验哈希（失败终止命令） → 同步缓存 → 提交推送
- **批处理**：支持从文件批量读取URL

**选项**：
- `<URL>`：下载地址
- `--batch-file <path>`：批量下载文件路径（txt文件，一行一个URL）
- `--fetch`：仅获取元数据预览（不下载）
- `--no-preview`：隐藏元数据预览

**别名**：
- `fetch` = `download --fetch`

### 8. `analyze` 命令
**功能**：分析元数据
**核心行为**：
- **搜索**：支持关键词搜索、字段指定搜索、行号读取
- **过滤**：支持缺失字段过滤
- **字段提取**：支持读取指定字段
- **统计**：提供库统计信息（条目数量，歌词、封面覆盖率）（无参数输出统计），并且输出无法在cache中找到的oid
- 输出中包含条目行号，`--read-fields`未指定oid时默认隐藏oid

**选项**：
- `<query>`：搜索关键词（默认在所有字段搜索，输出所有匹配项）
- `--search-field <field>`：仅在指定字段搜索，未使用此参数指定oid时从不在oid中搜索
- `--line <n>`：按行号过滤输出（逗号分隔，也可xx-xx表范围），提供短参数`-l`
- `--read <fields>`：提取指定字段（逗号分隔）
- `--missing <field>`：过滤出缺失指定字段的条目
- `--filter <fields>`：输出时过滤字段（可与`--read-fields`搭配使用）
- `--limit <n>`：限制输出数量（默认10）

### 9. `compress_images` 命令
**功能**：优化封面图片体积
**核心行为**：
- 仅处理大于500KB的封面
- 使用ffmpeg将图片转为略小于500KB的较高质量JPG
- **原子操作**：压缩后计算新哈希，若哈希改变则更新元数据

**选项**：
- `--size <n>`：压缩阈值（可带单位，大小写不敏感：kb mb gb，无单位默认kb）

## 四、系统配置与架构

### 路径传递
- **原则**：所有脚本不硬编码路径（包括相对路径）
- **配置文件**：`config.yaml`位于项目根目录，包含：
 - 本地路径配置
 - 远程服务器配置（user，host等）

### 复合工作流
- **`publish`完整流程**：分析并用户确认  → 保存文件并更新metadata → 压缩封面（cli层）  → 校验哈希（cli层）  → 同步上传（cli层）  → Git提交推送（库） 
- **`download`完整流程**：下载 → 压缩封面（cli层） → 校验哈希（cli层） → 同步缓存（cli层） → Git提交推送（库） 
- **`release`完整流程**：同步缓存（cli层） → 校验哈希（cli层） → Git pull（此步骤集成在脚本中） → 生成成品

## 五、关键确认细节

1. **文件名清理**：统一将非法字符替换为下划线`_`
2. **`sync`命令**：配置从`config.yaml`读取，添加超时和重试机制
3. 《cli层》指在cli层完成链式调用
