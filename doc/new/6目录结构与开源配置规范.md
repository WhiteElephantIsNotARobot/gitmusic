### 目录结构设计与开源项目配置规范

本规范基于你提供的 GitMusic v2.0 目录草案，明确项目目录、模块职责、命名约定、配置与打包、开发与发布流程、测试与迁移步骤，目标是：**单一真相、职责清晰、易维护、便于贡献与自动化 CI/CD**。文档面向开发者与维护者，便于直接落地。

---

### 项目总体布局与设计原则
- **单一真相**：每项功能的实现只在一个位置声明。命令定义仅在 `src/gitmusic/commands`，业务逻辑仅在 `src/gitmusic/core`，UI 渲染仅在 `src/gitmusic/ui`。  
- **职责分层**：  
  - **CLI 层**（`src/gitmusic/cli.py`）负责启动、解析、构建 Context、加载命令注册表、订阅事件与生命周期管理。  
  - **命令层**（`src/gitmusic/commands/*`）为薄适配器：声明参数、把 args 映射为步骤输入、按步骤调用 core API、处理命令级 on_error 策略。  
  - **核心库层**（`src/gitmusic/core/*`）实现所有确定性 I/O、数据一致性、远端交互与业务逻辑。  
  - **UI 层**（`src/gitmusic/ui/*`）统一渲染接口并根据运行模式决定输出行为。  
- **可替换性**：UI、transport、locking 等通过抽象接口实现，便于替换或 mock。  
- **可测试性**：每个命令与每个核心函数都应可独立单元测试，UI 提供 Capture 渲染器用于断言。

---

### 目录说明与模块职责
#### 顶层文件
- **pyproject.toml**：项目构建与依赖声明（推荐使用 Poetry 或 PEP 621）。  
- **config.example.yaml**：示例配置，包含路径、transport、ffmpeg、logs_dir、ui 样式覆盖项。  
- **README.md / LICENSE**：项目说明与许可证。  
- **gitmusic.ps1**：保留 PowerShell 启动脚本，作为平台友好入口。

#### 源代码包 src/gitmusic
- **cli.py**：主入口。职责：读取 `GITMUSIC_CONFIG`、构建 `Context`、调用 `commands.discover_commands()`、创建 argparse 子解析器、订阅 `events`、注入 `ui` 渲染器、分发命令执行、统一退出码与清理。不得包含命令实现细节。  
- **commands/**：每个命令一个模块（`publish.py`、`checkout.py` 等）。每个模块导出 `register(registry)` 或 `Command` 实例，包含 `add_arguments(parser)` 与 `run(ctx, args)`。命令模块只做参数映射与步骤组合。  
- **core/**：业务实现，模块职责如下：  
  - `object_store.py`：本地 cache 管理、路径解析、幂等写入、引用计数辅助。  
  - `metadata.py`：加载/验证/增量更新 `metadata.jsonl`、生成引用表、原子写入与 commit 辅助。  
  - `transport.py`：远端传输抽象（ScpAdapter 默认），实现上传/下载、远端 sha256 校验、重试策略。  
  - `locking.py`：文件/进程锁实现，保护 metadata 写入与关键并发操作。  
  - `audio.py`：音频 I/O、封面提取/压缩、标签嵌入、原子写入。  
  - `hash_utils.py`：统一哈希计算并记录 tooling（ffmpeg 版本与参数）。  
  - `git.py`：git 操作封装（pull、commit、push）。  
  - `context.py`：运行时 Context 定义（paths、transport、events、ui、executor、mode）。  
  - `events.py`：EventEmitter，负责写 JSONL 日志并在 interactive 模式提供回调订阅。  
- **ui/**：渲染层，包含：  
  - `renderer.py`：`UIRenderer` 抽象基类定义 `render_table`、`render_progress`、`render_event`、`render_panel`、`flush`。  
  - `rich_renderer.py`：`RichUIRenderer`，使用 `rich` 渲染表格、聚合进度、错误高亮，兼容覆盖行或追加行的终端行为。  
  - `noop_renderer.py`：`NoopUIRenderer`，log-only 或测试模式下不渲染，但可把结构化表格/事件写入事件日志。  
  - `table_registry.py`：`TableStyleRegistry`，集中注册表格样式（`publish_preview`、`release_results` 等），支持 config 覆盖。  
- **exceptions.py**：自定义异常类型（`ValidationError`、`TransportError`、`LockError` 等）。

#### 文档与测试
- **docs/**：命令规范、操作手册、故障排查与新规范文档。  
- **tests/**：单元与集成测试，`conftest.py` 提供 `ctx` 测试桩与 mock transport。  
- **archive/**：废弃脚本与历史文档，保留以便审计但不参与构建或运行。

---

### 配置、路径与 I O 约定
- **配置加载**：CLI 在启动时读取 `GITMUSIC_CONFIG` 环境变量或默认 `project_root/config.yaml`，构建 `Context` 并解析所有路径为绝对路径。库函数不得自行查找配置。  
- **Context 内容**：`project_root`、`work_dir`、`cache_dir`、`release_dir`、`logs_dir`、`tmp_dir`、`transport`、`events`、`ui`、`executor`、`mode`。  
- **临时文件与原子写入**：所有写操作遵循 `write to tmp → fsync → os.replace(tmp, target) → fsync(parent)`。写入 metadata 前必须 acquire lock。  
- **远端传输**：通过 `transport` 抽象完成，上传流程为 `local_tmp → upload → remote_sha256 → compare → remote_move`，支持重试与指数退避。  
- **日志**：运行日志写入 `logs_dir/<command>-YYYYMMDD-HHMMSS.jsonl`，每行 JSON 事件包含 `ts`、`cmd`、`type`、`phase`、`id`、`status`、`message`、`artifacts`。 interactive 模式 CLI 不打印 JSON； log-only 模式事件写 stdout。

---

### UI 标准与样式注册
- **单一渲染入口**：命令模块只调用 `ctx.ui` 的方法，不直接使用 `rich`。  
- **TableSpec 与 TableStyleRegistry**：集中定义表格列、对齐、宽度、颜色映射与最大行数。命令通过样式 id 请求渲染。  
- **进度策略**：批量任务使用聚合进度条；短任务合并为 batch updates；长任务可发 `progress` 事件触发单项进度条。  
- **运行模式处理**：`ctx.mode` 决定注入 `RichUIRenderer` 或 `NoopUIRenderer`。命令仅在必要交互点检查 `ctx.mode`（例如 preview 确认），避免在每处渲染前判断。  
- **可测试渲染**：提供 `CaptureUIRenderer` 用于断言渲染调用，便于单元测试命令输出逻辑。

---

### 打包、发布与 CI 配置
- **打包**：使用 `pyproject.toml`（PEP 621）声明包名 `gitmusic`、入口点 `console_scripts = gitmusic=gitmusic.cli:main`，便于 `pip install .` 安装。  
- **CI 流程**：建议 GitHub Actions 或等效 CI，包含步骤：静态检查（ruff/flake8）、类型检查（mypy）、单元测试、集成 smoke tests（小样本）、构建 wheel、发布到 PyPI 或内部索引（按 tag）。  
- **Release 策略**：语义化版本控制，发布前运行全量集成测试（500+ 条样本或模拟），并生成变更日志。  
- **容器化**：若需要在服务器以 systemd 运行，提供 Dockerfile 与 systemd unit 示例，systemd 启动使用 `--log-only` 模式以便捕获 stdout。

---

### 测试、迁移与验收
- **迁移步骤**：  
  1. 冻结公共 API（Context、UIRenderer、TableSpec、events）。  
  2. 实现 `events.emit()` 与日志持久化。  
  3. 实现 `UIRenderer` 与 `TableStyleRegistry`，在 CLI 初始化注入。  
  4. 实现 `CommandRegistry` 并迁移 `publish` 为首个命令模块。  
  5. 逐个迁移其余命令并运行回归测试。  
  6. 全量回归与性能调优。  
- **测试矩阵**：单元测试覆盖核心模块、命令模块使用 mock ctx；集成测试覆盖 end-to-end 流程；故障注入测试网络中断、哈希不匹配、磁盘不足。  
- **验收标准**：interactive 模式渲染美观且不打印 JSON；log-only 模式输出 JSONL；metadata 写入原子且远端校验通过；全量运行错误率在可接受范围并记录性能指标。

---

### 开源项目治理与贡献指南
- **贡献流程**：Fork → feature branch → PR（包含单元测试与类型检查）→ CI 通过 → 代码审查 → 合并。  
- **代码风格**：PEP8、类型注解、docstring。使用 pre-commit 钩子（ruff、black、isort）。  
- **文档**：`docs/` 包含命令规范、操作手册与故障排查。变更需同步更新 `command-spec.md`。  
- **安全与凭据**：SSH 私钥与敏感配置不入库；示例凭据放在 `config.example.yaml`，实际凭据由运维管理。  
- **版本与发布**：使用语义化版本，发布时更新 `CHANGELOG.md` 并在 release notes 中列出迁移步骤。

---

### 交付物与下一步建议
- **交付物**：`commands_registry.py`、`UIRenderer` 抽象与 `RichUIRenderer` 骨架、`publish` 命令示例模块、`config.example.yaml`、CI 工作流模板、测试用例模板。  
- **短期优先项**：实现 `events.emit()` 与日志持久化；实现 `UIRenderer` 与 `TableStyleRegistry`；迁移 `publish` 并验证行为一致。  
- **长期目标**：完善集成测试覆盖、实现多 transport 适配器、提供运维监控指标导出。

---

此规范把目录结构、模块职责、UI 渲染、I/O 与远端访问、打包与 CI、迁移与测试流程一并固定为可执行标准。按此执行可显著降低重复实现、提高可维护性并便于社区贡献。