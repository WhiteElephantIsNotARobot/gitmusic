# GitMusic 架构重构实施计划

**计划版本:** 1.0  
**制定日期:** 2026-01-20  
**制定者:** opencode  
**参考文档:** 
- [1规范.md](../1规范.md) - 总体架构规范
- [2CLI视觉规范&库规范.md](../2CLI视觉规范&库规范.md) - CLI输出与库接口规范  
- [3命令规范.md](../3命令规范.md) - 命令详细实现规范
- [4库函数职责规范.md](../4库函数职责规范.md) - 库函数职责边界规范
- [审查报告1](../review/1.md)、[审查报告2](../review/2.md)、[审查报告3](../review/3.md)、[审查报告4](../review/4.md) - 规范符合性审查

## 1. 概述

基于对现有代码库的全面审查（见各审查报告），当前实现已基本建立规范要求的架构框架，但存在多个关键差距需要弥补。本计划旨在系统性解决这些差距，确保实现完全符合所有规范要求。

### 1.1 当前状态
- ✅ **架构基础**: 单一运行时模型、CLI与库分离、事件驱动系统已实现
- ✅ **核心模块**: metadata、object_store、audio_io、hash、locking、events等模块基础功能完整
- ✅ **命令框架**: 所有命令已注册，工作流基本实现

### 1.2 关键差距（根据审查报告）
1. **日志策略缺失** - 事件流未持久化到文件，无log-only模式支持 [审查报告1:43, 审查报告2:48-54, 审查报告3:43-47]
2. **传输完整性缺失** - TransportAdapter缺少远端SHA256校验和重试策略 [审查报告1:92-94, 审查报告2:75-76, 审查报告3:92-94, 审查报告4:89-112]
3. **数据校验缺失** - metadata字段无格式和内容校验 [审查报告2:102-112]
4. **测试完全缺失** - 无单元测试、集成测试、性能测试 [审查报告1:194, 审查报告2:157-164, 审查报告3:345]
5. **CLI视觉输出不符** - 无Header行、事件流格式不规范、进度信息不全 [审查报告2:24-33]
6. **参数支持不全** - 多个命令缺少规范要求的参数 [审查报告3:200-323]
7. **错误处理不完整** - `on_error`策略未实际应用 [审查报告1:166-171, 审查报告3:176-178]
8. **Context不完整** - 缺少完整路径注入，临时目录未统一 [审查报告4:24-38]
9. **原子写入不完整** - 缺少fsync操作，数据持久性不足 [审查报告4:64-86]
10. **返回值未结构化** - 库函数返回简单类型而非结果对象 [审查报告4:149-161]

### 1.3 实施优先级
根据规范重要性和影响范围，将上述差距分为三个优先级：
- **高优先级** (P0): 日志持久化、传输校验、metadata校验、测试基础
- **中优先级** (P1): CLI视觉完善、参数补全、错误处理、Context完善
- **低优先级** (P2): 原子写入完善、返回值结构化、临时目录统一

## 2. 目标与范围

### 2.1 总体目标
在**4周内**完成所有高优先级和中优先级改进，使系统达到生产就绪状态，完全符合所有规范要求。

### 2.2 具体目标
1. **日志系统**: 实现事件流持久化到`logs/<command>-TIMESTAMP.jsonl`，支持log-only模式
2. **传输完整性**: TransportAdapter实现远端SHA256校验和可配置重试策略
3. **数据一致性**: metadata字段实现完整校验，确保数据质量
4. **测试覆盖**: 建立单元测试、集成测试、故障注入测试框架
5. **用户体验**: CLI输出完全符合视觉规范，提供丰富的进度和状态信息
6. **命令完整性**: 所有命令参数和工作流符合规范要求
7. **错误处理**: 完全实现`on_error`的stop/continue/notify策略
8. **架构完善**: 构建完整Context对象，统一路径管理和临时文件处理

### 2.3 范围边界
- **包含**: libgitmusic库改进、CLI增强、测试框架建立
- **不包含**: 新功能开发、第三方库替换、性能大规模优化
- **交付物**: 完全符合规范的代码库、测试套件、更新文档

## 3. 时间线与里程碑

### 3.1 总体时间线（4周）
```
第1周: 基础架构完善 (日志、传输、Context)
第2周: 数据校验与测试框架 (metadata校验、测试基础)
第3周: CLI与命令完善 (视觉输出、参数补全)
第4周: 集成测试与收尾 (全量回归、文档更新)
```

### 3.2 详细里程碑

#### 里程碑1: 日志与传输基础 (第1周末)
- [x] 实现事件流持久化到JSONL文件
- [x] 支持log-only模式输出
- [x] TransportAdapter实现远端SHA256校验
- [x] 实现可配置重试策略
- [x] 建立完整Context对象

#### 里程碑2: 数据校验与测试 (第2周末)
- [x] metadata字段完整校验实现（含日期格式标准化与重复检查）
- [x] 建立单元测试框架和基础测试
- [x] 实现结构化返回值类
- [x] 定义具体异常类型

#### 里程碑3: CLI视觉与命令完善 (第3周末)
- [x] CLI输出符合视觉规范（Header行、事件流格式、进度信息）
 - [x] 补全所有命令缺失参数
- [x] 完全实现`on_error`错误处理策略
- [x] 实现并发调度统一管理

#### 里程碑4: 集成测试与交付 (第4周末)
- [x] 完成集成测试覆盖主要命令链
- [ ] 进行全量回归测试（500+数据）
- [ ] 更新所有相关文档
- [ ] 归档旧脚本和兼容性包装器

## 4. 详细实施计划

### 4.1 第1周：基础架构完善

#### 任务1.1: 日志持久化实现
**目标**: 实现规范要求的日志策略 [2CLI视觉规范&库规范.md:49-63]
- **实施**:
  1. 在`EventEmitter`中添加日志文件写入功能
  2. 支持`logs/<command>-YYYYMMDD-HHMMSS.jsonl`命名格式
  3. 实现log-only模式（`--log-only`参数）
  4. 添加日志目录配置支持（`logsdir` in config.yaml）
- **验收标准**:
  - interactive模式不打印JSON，仅渲染人类友好输出
  - log-only模式输出JSONL到stdout
  - 事件流同时写入日志文件
- **任务清单**:
  - [x] 修改`EventEmitter.emit()`支持文件写入
  - [x] 在CLI中实现`--log-only`参数处理
  - [x] 添加`logsdir`配置支持
  - [x] 确保日志文件不包含敏感凭据

#### 任务1.2: TransportAdapter增强
**目标**: 实现传输完整性校验 [4库函数职责规范.md:89-112]
- **实施**:
  1. 在`TransportAdapter.upload()`中添加远端SHA256校验
  2. 实现上传流程：本地tmp → fsync → 上传 → 远端sha256sum → 比对 → 原子替换
  3. 添加可配置重试策略（指数退避，config控制）
  4. 实现幂等上传（检查远端哈希匹配）
- **验收标准**:
  - 上传后自动执行远端sha256sum验证
  - 支持config.yaml配置重试次数和超时
  - 相同哈希文件不上传重复内容
- **任务清单**:
  - [x] 实现远端命令执行和哈希获取
  - [x] 添加上传后的哈希比对逻辑
  - [x] 集成重试机制到transport模块
  - [x] 添加幂等性检查（基于哈希而非路径）

#### 任务1.3: Context对象完善
**目标**: 统一路径管理和临时文件处理 [4库函数职责规范.md:11-18]
- **实施**:
  1. 创建完整`Context`类，包含所有规范要求的路径字段
  2. CLI在启动时构建Context并注入所有路径
  3. 提供统一的`tmp_dir`管理
  4. 添加路径验证（存在性、权限、磁盘空间）
- **验收标准**:
  - 所有库函数通过Context获取路径
  - 临时文件统一使用`ctx.tmp_dir`
  - 路径验证在写入前执行
- **任务清单**:
  - [x] 设计并实现`Context`类
  - [x] 修改CLI构建Context的代码
  - [x] 更新所有库函数使用Context参数
  - [x] 实现路径验证和安全检查

### 4.2 第2周：数据校验与测试框架

#### 任务2.1: metadata字段校验
**目标**: 实现完整的数据一致性校验 [2CLI视觉规范&库规范.md:92-112]
- **实施**:
  1. 在`MetadataManager`中添加`validate_entry()`方法
  2. 实现字段级校验规则：
     - `audio_oid`: 匹配 `^sha256:[0-9a-f]{64}$`
     - `title`: 非空字符串（清理后长度>0）
     - `artists`: 非空数组，元素非空字符串
     - `date`: 若存在必须为YYYY-MM-DD格式
     - `created_at`: 必须为UTC ISO8601时间戳
  3. 添加空值策略处理
  4. 确保字段顺序写入
- **验收标准**:
  - 所有写入metadata.jsonl的数据都通过校验
  - 无效数据被拒绝并emit error事件
  - 字段顺序一致便于diff和审计
- **任务清单**:
  - [x] 实现`validate_entry()`校验方法
  - [x] 添加各字段的具体校验规则
  - [x] 集成校验到`addorupdate()`流程
  - [x] 确保写入时的字段顺序统一

#### 任务2.2: 测试框架建立
**目标**: 建立全面的测试覆盖 [1规范.md:111-122]
- **实施**:
  1. 创建`tests/`目录结构
  2. 实现单元测试框架（pytest）
  3. 编写核心模块基础测试：
     - metadata字段校验测试
     - hash计算正确性测试
     - object_store原子写入测试
     - transport基础功能测试
  4. 创建集成测试模板
- **验收标准**:
  - 核心模块有基础单元测试
  - 测试能够快速执行
  - 测试覆盖关键路径和边界条件
- **任务清单**:
  - [x] 设置测试目录和pytest配置
  - [x] 编写metadata模块测试
  - [x] 编写object_store模块测试
  - [x] 编写transport模块测试

#### 任务2.3: 结构化返回值与异常
**目标**: 完善库函数接口契约 [4库函数职责规范.md:141-161]
- **实施**:
  1. 定义结构化结果类：`StoreResult`、`RemoteResult`、`VerifyResult`等
  2. 定义具体异常类：`ValidationError`、`TransportError`、`IOError`、`LockError`
  3. 更新库函数返回结构化对象而非简单类型
  4. 确保异常抛出前emit对应error事件
- **验收标准**:
  - 关键函数返回结构化结果对象
  - 异常类型明确，便于错误处理
  - 错误事件包含完整上下文信息
- **任务清单**:
  - [x] 设计并实现结果类
  - [x] 定义具体异常类
  - [x] 更新库函数返回类型
  - [x] 确保错误处理一致性

### 4.3 第3周：CLI视觉与命令完善

#### 任务3.1: CLI视觉输出改进
**目标**: 完全符合视觉规范要求 [2CLI视觉规范&库规范.md:6-46]
- **实施**:
  1. 实现Header行显示：`时间 | 命令 | 阶段 | 总数 | 状态`
  2. 完善进度条：添加items/sec和ETA计算
  3. 规范事件流格式：`时间 [状态] 文件 - 操作`
  4. 实现表格渲染：publish预览、release结果、verify报告表格
  5. 改进Summary面板：使用rich.Panel，包含logfile信息
- **验收标准**:
  - 输出为单列持续滚动，美观一致
  - 进度信息丰富，包括速率和预估时间
  - 表格支持分页和截断
  - Summary包含所有关键统计信息
- **任务清单**:
  - [x] 实现Header行渲染
  - [x] 增强rich.Progress显示项目
  - [x] 规范item_event输出格式
  - [x] 实现各命令的专用表格

#### 任务3.2: 命令参数补全
**目标**: 所有命令支持规范要求的参数 [3命令规范.md:15-244]
- **实施**:
  1. **checkout**: 添加`--search-field`、`--line`参数
  2. **verify**: 添加`--delete`参数和回收站功能
  3. **release**: 添加`--force`、`--workers`参数
  4. **download**: 添加`--fetch`、`--no-preview`参数
  5. **analyze**: 添加`--filter`、`--limit`参数
  6. **compress_images**: 改为`--size`参数，支持单位解析
- **验收标准**:
  - 所有命令参数与规范完全一致
  - 参数功能完整实现
  - 参数命名和用法符合规范
 - **任务清单**:
   - [x] 分析每个命令的参数差距
   - [x] 逐个实现缺失参数
   - [x] 更新参数解析和验证
   - [x] 确保向后兼容性

#### 任务3.3: 错误处理策略实现
**目标**: 完全实现`on_error`策略 [1规范.md:93-96]
- **实施**:
  1. 在CLI的`run_command()`中根据`on_error`值采取不同行为
  2. 实现三种策略：
     - `stop`: 遇error立即停止命令
     - `continue`: 记录error但继续执行后续项
     - `notify`: 继续执行，在summary中报告所有error
  3. 修正release命令的`on_error`应为`continue`
  4. 确保错误汇总和报告功能
- **验收标准**:
  - `on_error`策略实际生效
  - 错误被正确记录和报告
  - summary包含错误统计
- **任务清单**:
  - [x] 修改`run_command()`实现策略选择
  - [x] 实现错误收集和汇总
  - [x] 修正各命令的`on_error`默认值
  - [x] 确保错误事件与策略一致

### 4.4 第4周：集成测试与收尾

#### 任务4.1: 集成测试实现
**目标**: 建立端到端测试覆盖 [1规范.md:111-115]
- **实施**:
  1. 创建集成测试目录`tests/integration/`
  2. 实现关键命令链测试：
     - `publish → sync → release`流程
     - `checkout → publish`冲突处理
     - `download → publish`完整流程
  3. 添加故障注入测试：
     - 网络中断恢复测试
     - 哈希不匹配处理测试
     - 文件冲突解决测试
  4. 创建小样本测试数据集
- **验收标准**:
  - 主要命令链有集成测试
  - 故障场景能够正确处理
  - 测试可在隔离环境中运行
- **任务清单**:
  - [x] 设计集成测试框架
  - [x] 创建测试数据集
  - [x] 实现命令链测试
  - [x] 实现故障注入测试

#### 任务4.2: 全量回归测试
**目标**: 验证系统稳定性和性能 [2CLI视觉规范&库规范.md:131-135]
- **实施**:
  1. 准备500+条测试数据
  2. 运行完整发布流程测试
  3. 监控和记录性能指标：items/sec、错误率、内存使用
  4. 验证日志持久化完整性和正确性
  5. 测试log-only模式与systemd集成
- **验收标准**:
  - 全量运行成功，错误率<1%
  - 性能指标符合预期
  - 日志文件完整可解析
  - log-only模式输出正确JSONL
- **任务清单**:
  - [ ] 准备大规模测试数据
  - [ ] 设计性能测试脚本
  - [ ] 执行全量回归测试
  - [ ] 分析结果并调优

#### 任务4.3: 文档更新与归档
**目标**: 完善项目文档，归档旧代码 [1规范.md:117-122]
- **实施**:
  1. 创建`command-spec.md`详细说明各命令用法
  2. 更新`config.example.yaml`包含所有配置项
  3. 编写操作手册和故障排查清单
  4. 归档旧脚本到`archive/`目录
  5. 更新README.md反映新架构
- **验收标准**:
  - 文档完整、准确、易懂
  - 配置示例包含所有选项
  - 旧脚本被正确归档
  - README反映当前架构
- **任务清单**:
  - [ ] 编写command-spec.md
  - [ ] 完善config.example.yaml
  - [ ] 创建操作手册
  - [ ] 归档兼容性脚本

## 5. 风险与缓解措施

### 5.1 技术风险
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 远端校验影响性能 | 中 | 中 | 实现并行校验，优化SSH连接复用 |
| 原子写入fsync影响IO性能 | 低 | 低 | 仅关键数据使用fsync，提供配置选项 |
| 大规模测试数据准备耗时 | 高 | 中 | 提前准备，使用脚本自动化生成 |
| 旧脚本兼容性问题 | 中 | 低 | 保持兼容性包装器，逐步迁移 |

### 5.2 进度风险
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 测试框架建立超时 | 中 | 中 | 优先实现基础测试，复杂测试后续迭代 |
| CLI视觉改进复杂度高 | 高 | 中 | 分阶段实施，先核心功能后优化 |
| 参数补全工作量大 | 中 | 低 | 按命令优先级逐个实现 |

### 5.3 质量风险
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 新功能引入回归缺陷 | 高 | 高 | 严格执行测试驱动开发，每项改进都有测试 |
| 日志系统影响现有功能 | 中 | 中 | 逐步启用，先实现后切换，充分测试 |
| 传输校验导致上传失败 | 中 | 高 | 实现降级机制，校验失败可配置跳过 |

## 6. 交付物

### 6.1 代码交付物
- [x] `libgitmusic/` - 增强的核心库，包含：
  - 完整的metadata字段校验
  - 支持远端校验的TransportAdapter
  - 结构化结果类和具体异常
  - 统一的Context支持
 - [x] `tools/cli.py` - 增强的CLI，包含：
   - 符合视觉规范的输出
   - 完整的log-only模式支持
   - 正确的`on_error`策略实现
   - 所有命令参数支持
- [x] `tests/` - 完整的测试套件，包含：
  - 单元测试覆盖核心模块
  - 集成测试覆盖主要命令链
  - 故障注入测试
  - 性能测试基准

### 6.2 配置与文档
- [x] `config.example.yaml` - 完整的配置示例
- [ ] `command-spec.md` - 命令规范详细文档
- [ ] `OPERATION.md` - 操作手册
- [ ] `TROUBLESHOOTING.md` - 故障排查清单
- [ ] 更新后的`README.md`

### 6.3 迁移辅助
- [ ] `archive/`目录 - 归档的旧脚本和兼容性包装器
- [ ] 迁移检查脚本
- [ ] 配置迁移指南

## 7. 成功标准

### 7.1 技术标准
1. **规范符合性**: 通过所有审查报告项的验证
2. **测试覆盖率**: 核心模块单元测试覆盖率>80%
3. **性能指标**: 全量测试错误率<1%，性能符合基线要求
4. **代码质量**: 通过代码审查，无重大技术债务

### 7.2 功能标准
1. **日志系统**: 事件流完整持久化，log-only模式可用
2. **传输完整性**: 所有上传文件通过远端SHA256验证
3. **数据一致性**: metadata字段100%通过校验
4. **用户体验**: CLI输出美观、信息丰富、符合规范

### 7.3 运维标准
1. **可维护性**: 文档完整，代码结构清晰
2. **可观测性**: 日志提供完整操作追踪
3. **可部署性**: 配置简单，依赖明确
4. **可扩展性**: 架构支持未来功能扩展

---

**计划批准:**  
**日期:** 2026-01-20  
**下一步:** 开始实施第1周任务