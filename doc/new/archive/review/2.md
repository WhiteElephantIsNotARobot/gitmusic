# 规范符合性审查报告

**审查日期:** 2026-01-20  
**审查对象:** repo/ 下实现  
**对照规范:** doc/new/2CLI视觉规范&库规范.md  
**审查者:** opencode

## 概述

根据《CLI视觉规范&库规范》文档，对当前代码库实现进行全面审查。规范定义了CLI输出设计（单列持续滚动、rich渲染、log-only模式）、日志策略（JSONL事件写入）、libgitmusic库层职责与接口契约、数据一致性校验、传输适配器细节等核心要求。本报告评估实际实现与规范的符合程度，识别差距与改进建议。

---

## 1. CLI输出设计

### 1.1 输出原则

| 规范要求 | 实现现状 | 状态 |
|----------|----------|------|
| 单列单块持续滚动：所有输出按时间顺序追加到终端 | CLI使用`progress.console.print()`追加输出 | ✅ 符合 |
| 交互模式与log-only模式分离：interactive使用rich渲染，log-only输出JSONL到stdout | CLI仅实现interactive模式，无log-only模式 | ❌ 不符合 |
| 事件不可见化：库产生JSON事件写入日志文件，CLI在interactive模式不打印JSON | `EventEmitter.emit`在无监听器时输出JSON到stdout，但未写入日志文件 | ⚠️ 部分符合 |

### 1.2 主输出元素

| 输出元素 | 规范要求 | 实现现状 | 状态 |
|----------|----------|----------|------|
| Header行 | `2026-01-20T15:10:00Z | publish | phase=scan_work | total=120 | status=running` | 无Header行，仅进度条任务创建 | ❌ 不符合 |
| 主进度行 | 使用rich.progress.Progress，包含Description、BarColumn、Percentage、TextColumn(items/sec)、TimeRemainingColumn | 使用rich.progress.Progress，但缺少items/sec和ETA列 | ⚠️ 部分符合 |
| 最近事件流 | `15:10:05 [OK] Artist - Title.mp3 — wrote release` 逐行追加 | 显示为表格形式，非逐行追加格式 | ⚠️ 部分符合 |
| 表格渲染 | publish预览表格、release结果表格、verify报告表格 | `_display_summary`显示摘要表格，但无规范要求的具体表格 | ⚠️ 部分符合 |
| Summary面板 | 使用rich.panel.Panel显示processed、errors、warnings、elapsed、rate、logfile | `_display_summary`显示表格摘要，非Panel形式，缺少logfile信息 | ⚠️ 部分符合 |

### 1.3 进度策略

| 策略 | 规范要求 | 实现现状 | 状态 |
|------|----------|----------|------|
| 批量/阶段粒度 | 对大量短任务只显示阶段级batch_progress | 使用`EventEmitter.batch_progress`显示阶段进度 | ✅ 符合 |
| 短任务合并 | 单项耗时<1s不创建单项进度条，仅在item_event记录 | 进度条任务为阶段级，符合要求 | ✅ 符合 |
| ETA计算 | 基于滑动窗口速率估算剩余时间 | 未实现ETA计算 | ❌ 不符合 |

---

## 2. 日志策略与配置

### 2.1 日志文件与JSONL事件

| 规范要求 | 实现现状 | 状态 |
|----------|----------|------|
| 日志目录：默认<projectroot>/logs/，可在config.yaml中配置logsdir | config.yaml无logsdir配置，未创建logs目录 | ❌ 不符合 |
| 事件写入：库通过EventEmitter.emit()将事件写入当前运行的日志文件 | `EventEmitter.emit`仅在无监听器时输出JSON到stdout，未写入文件 | ❌ 不符合 |
| log-only模式：CLI将事件JSONL写入stdout，便于systemd捕获 | 无`--log-only`参数支持 | ❌ 不符合 |
| 日志命名：`<logs_dir>/<command>-YYYYMMDD-HHMMSS.jsonl` | 未实现 | ❌ 不符合 |
| 日志轮转：建议实现按大小或按天轮转策略 | 未实现 | ❌ 不符合 |

### 2.2 配置与启动

| 规范要求 | 实现现状 | 状态 |
|----------|----------|------|
| config路径：默认项目根，可通过环境变量GITMUSIC_CONFIG指定自定义路径 | CLI使用`_load_config`加载config.yaml，支持自定义路径 | ✅ 符合 |
| 日志路径覆盖：GITMUSICLOGS或--logs CLI参数覆盖config中logsdir | 未实现 | ❌ 不符合 |

---

## 3. libgitmusic库层架构与接口契约

### 3.1 模块职责对照

| 模块 | 规范职责 | 实现现状 | 状态 |
|------|----------|----------|------|
| metadata | 索引加载、字段校验、增量更新、原子写入 | 提供加载、保存、更新功能，但缺少字段校验和commit方法 | ⚠️ 部分符合 |
| object_store | 本地cache管理、对象写入、路径解析、幂等写入 | 提供存储、检索、完整性验证，支持原子写入 | ✅ 符合 |
| audio_io | 分离音频流、提取封面、压缩封面、嵌入标签、原子写入 | 提供提取音频流、封面、嵌入元数据，缺少compresscover方法 | ⚠️ 部分符合 |
| hash | 统一音频帧哈希计算并记录tooling | `HashUtils.hash_audio_frames`记录tooling信息 | ✅ 符合 |
| transport | 传输抽象与ScpAdapter实现，上传下载含远端sha256校验 | 提供SCP上传下载，但缺少远端哈希校验和重试策略 | ❌ 不符合 |
| events | 事件发射器，写入日志文件 | `EventEmitter.emit`输出JSON，但未写入日志文件 | ⚠️ 部分符合 |
| locking | 写锁管理，acquire(name, timeout)返回LockHandle | `LockManager`提供文件锁、进程锁，但接口略有不同 | ✅ 基本符合 |

### 3.2 接口签名对照

| 规范示例 | 实现对应 | 状态 |
|----------|----------|------|
| `MetadataManager.addorupdate(entry: dict) -> None` | `update_entry(audio_oid: str, updates: Dict) -> None` | ⚠️ 部分符合（参数不同） |
| `ObjectStore.storeaudio(temppath: Path) -> StoreResult` | `store_audio(temp_path: Path, compute_hash: bool = True) -> str` | ⚠️ 部分符合（返回str而非StoreResult） |
| `AudioIO.extractcover(src: Path) -> bytes` | `extract_cover(audio_path: Path) -> Optional[bytes]` | ✅ 符合 |
| `HashUtils.hashaudioframes(path: Path, params: dict) -> str` | `hash_audio_frames(path, ffmpeg_params, record_tooling) -> str` | ✅ 符合 |
| `Transport.upload(local: Path, remote: str) -> RemoteResult` | `upload(local_path: Path, remote_subpath: str)` 无结果对象 | ❌ 不符合 |
| `EventEmitter.emit(event: dict) -> None` | `emit(event_type, **kwargs)` | ✅ 符合 |

### 3.3 返回结构与异常

| 规范要求 | 实现现状 | 状态 |
|----------|----------|------|
| 关键函数返回结构化对象（StoreResult、RemoteResult等） | 大部分函数返回简单类型（str、bool、None），无结构化结果对象 | ❌ 不符合 |
| 定义明确异常类（ValidationError, TransportError等） | 使用Python内置异常，无自定义异常类 | ❌ 不符合 |
| 库在抛出前emit对应error事件 | 部分代码emit error事件，但不一致 | ⚠️ 部分符合 |

---

## 4. 数据一致性校验与原子操作

### 4.1 Metadata写入规则

| 校验规则 | 规范要求 | 实现现状 | 状态 |
|----------|----------|----------|------|
| audio_oid校验 | 匹配 `^sha256:[0-9a-f]{64}$` | 无校验 | ❌ 不符合 |
| title校验 | 非空字符串 | 无校验 | ❌ 不符合 |
| artists校验 | 非空数组，元素非空字符串 | 无校验 | ❌ 不符合 |
| date校验 | 若存在必须为YYYY-MM-DD | 无校验 | ❌ 不符合 |
| created_at校验 | 必须为UTC ISO8601时间戳 | 无校验 | ❌ 不符合 |
| 空值策略 | 禁止写入空字符串 | 无策略 | ❌ 不符合 |
| 字段顺序 | 写入时按约定顺序便于diff | `_order_fields`统一字段顺序 | ✅ 符合 |

### 4.2 OID与对象一致性

| 规则 | 规范要求 | 实现现状 | 状态 |
|------|----------|----------|------|
| 本地校验 | 若audio_oid指向本地cache，重算哈希并比对 | `ObjectStore.verify_integrity`验证本地对象哈希 | ✅ 符合 |
| 远端校验 | 上传后在远端执行sha256sum并比对 | 未实现远端校验 | ❌ 不符合 |
| 幂等性 | 若对象已存在且哈希匹配，跳过写入 | `store_audio`检查文件存在性，但未校验哈希 | ⚠️ 部分符合 |
| 引用完整性 | MetadataManager能生成引用表用于cleanup | 未实现 | ❌ 不符合 |

### 4.3 原子写入与锁

| 规则 | 规范要求 | 实现现状 | 状态 |
|------|----------|----------|------|
| 原子写入流程 | 先写入.tmp，完成后mv覆盖目标文件 | `MetadataManager.save_all`、`AudioIO.atomic_write`使用临时文件替换 | ✅ 符合 |
| 锁保护 | 写入前获取LockManager锁 | `MetadataManager.acquire_lock`、CLI使用`LockManager` | ✅ 符合 |
| 并发策略 | CLI在需要写入的命令前统一获取锁 | CLI根据命令的`requires_lock`获取锁 | ✅ 符合 |

---

## 5. 传输适配器ScpAdapter细节

### 5.1 上传流程

| 步骤 | 规范要求 | 实现现状 | 状态 |
|------|----------|----------|------|
| 本地写.tmp | 使用临时文件 | 上传前文件应已存在，无本地.tmp步骤 | ⚠️ 部分符合 |
| scp上传到远端临时路径 | 上传到.tmp文件 | `upload`上传到`.tmp`文件 | ✅ 符合 |
| 远端执行sha256sum | 在远端计算哈希并比对 | 未实现远端哈希校验 | ❌ 不符合 |
| 比对成功后mv到目标目录 | 原子移动 | `mv`操作原子移动 | ✅ 符合 |
| 设置权限 | 设置适当权限 | 未设置权限 | ❌ 不符合 |

### 5.2 高级功能

| 功能 | 规范要求 | 实现现状 | 状态 |
|------|----------|----------|------|
| 重试策略 | 指数退避重试，重试次数由config控制 | config有retries参数，但未在代码中使用 | ❌ 不符合 |
| 幂等上传 | 若远端已存在且哈希匹配，跳过移动 | 未检查远端文件存在性或哈希 | ❌ 不符合 |
| 安全 | 使用SSH key，私钥由运维管理 | 依赖系统SSH配置 | ✅ 符合 |

---

## 6. 测试矩阵与验收标准

### 6.1 测试矩阵

| 测试类型 | 规范要求 | 实现现状 | 状态 |
|----------|----------|----------|------|
| 单元测试 | metadata校验、hash、audio_io、transport、locking | 未发现测试文件 | ❌ 不符合 |
| 集成测试 | publish→sync→release流程，小样本与全量测试 | 未发现测试脚本 | ❌ 不符合 |
| 故障注入 | 网络中断、哈希不匹配、缺封面、文件名冲突 | 未实现 | ❌ 不符合 |
| 性能测试 | 记录items/sec、并发瓶颈、IO延迟 | 未实现 | ❌ 不符合 |

### 6.2 验收标准

| 标准 | 规范要求 | 实现现状 | 状态 |
|------|----------|----------|------|
| 视觉验收 | interactive模式使用rich渲染进度条、表格与错误高亮 | 使用rich渲染，但缺少部分视觉元素 | ⚠️ 部分符合 |
| 日志验收 | log-only模式输出JSONL，systemd能直接捕获 | 无log-only模式 | ❌ 不符合 |
| 一致性验收 | metadata写入通过单元测试，object_store上传后远端sha256校验通过 | 无测试，无远端校验 | ❌ 不符合 |
| 稳定性验收 | 全量500+运行成功，错误率可接受并记录性能指标 | 未验证 | ❓ 未验证 |

### 6.3 迁移步骤对照

| 迁移步骤 | 规范建议 | 当前状态 |
|----------|----------|----------|
| 1. 冻结libgitmusic公共API | API基本定义但未冻结 | ⚠️ 部分完成 |
| 2. 实现EventEmitter与日志持久化（JSONL） | EventEmitter存在，但无日志持久化 | ⚠️ 部分完成 |
| 3. 实现CLI渲染骨架（rich）与log-only模式 | CLI渲染骨架存在，无log-only模式 | ⚠️ 部分完成 |
| 4. 实现MetadataManager与LockManager并编写单元测试 | 模块存在，无单元测试 | ⚠️ 部分完成 |
| 5. 实现Transport ScpAdapter并做端到端上传校验测试 | ScpAdapter存在，无远端校验测试 | ⚠️ 部分完成 |
| 6. 实现AudioIO基本功能并完成publish端到端流程测试 | AudioIO基本功能存在，无端到端测试 | ⚠️ 部分完成 |
| 7. 全量回归与性能调优，部署systemd worker使用--log-only | 未完成 | ❌ 未完成 |

---

## 7. 运维考量

| 考量点 | 规范要求 | 实现现状 | 状态 |
|--------|----------|----------|------|
| 安全 | SSH key管理、最小权限运行、日志权限控制 | 依赖系统SSH配置，无特别管理 | ⚠️ 依赖外部 |
| 监控 | 定期运行verify_hashes并把summary导出到监控系统 | `verify`命令存在，但无自动导出机制 | ⚠️ 部分符合 |
| 日志轮转 | 实现日志归档策略，避免logs/无限制增长 | 未实现日志持久化，故无轮转 | ❌ 不符合 |
| 团队流程 | 变更libgitmusic API需审查；CLI与库由同一维护组管理 | 无流程文档，但代码结构支持 | ⚠️ 依赖流程 |

---

## 总结与建议

### 总体评价
当前实现 **部分符合** 规范架构，核心模块基础完整，事件系统初步建立，CLI基本功能可用。但主要差距集中在 **日志策略缺失**、**传输层完整性校验缺失**、**metadata字段校验缺失**、**测试覆盖为零** 和 **CLI视觉输出不完全符合规范**。

### 关键差距
1. **日志策略完全缺失** - 无日志持久化、无log-only模式、无logs目录配置
2. **传输适配器不完整** - 缺少远端SHA256校验、重试策略、幂等上传
3. **metadata字段校验缺失** - 无任何字段格式和内容校验
4. **CLI视觉输出不符合规范** - 无Header行、无规范格式的事件流、无完整进度信息
5. **测试完全缺失** - 无单元测试、集成测试、故障注入或性能测试

### 高优先级建议
1. **实现日志持久化** - 在EventEmitter中添加日志文件写入，支持logs目录和log-only模式
2. **增强TransportAdapter** - 添加上传后的远端哈希校验，实现重试机制和幂等上传
3. **实现metadata字段校验** - 在MetadataManager中添加validate_entry方法，确保数据一致性
4. **完善CLI视觉输出** - 添加Header行，规范事件流格式，完善进度条显示
5. **创建测试套件** - 为库模块添加单元测试，为命令链添加集成测试

### 中优先级建议
6. **完善接口契约** - 使函数返回结构化结果对象，定义自定义异常类
7. **实现OID引用完整性** - 添加引用表生成功能，支持cleanup操作
8. **添加音频封面压缩** - 实现AudioIO.compress_cover方法
9. **完善配置管理** - 支持logsdir配置和环境变量覆盖

### 低优先级建议
10. **实现日志轮转** - 当日志持久化后，增加归档策略
11. **添加监控导出** - 将verify结果导出到监控系统
12. **完善错误处理策略** - 完全实现on_error的stop/continue/notify行为

---

## 附录：文件清单

### 核心文件
- `tools/cli.py` - CLI主程序（1457行）
- `libgitmusic/` - 核心库
  - `__init__.py` - 包初始化
  - `audio.py` - 音频I/O模块
  - `events.py` - 事件发射器（82行）
  - `metadata.py` - 元数据管理（82行）
  - `object_store.py` - 对象存储（204行）
  - `hash_utils.py` - 哈希计算
  - `transport.py` - 传输适配器（56行）
  - `locking.py` - 锁管理（193行）
  - `git.py` - Git操作
  - `commands/` - 各命令逻辑模块
- `config.yaml` - 配置文件（19行）

### 兼容性脚本（待归档）
- `data/cleanup_orphaned.py`
- `data/compress_images.py`
- `data/sync_cache.py`
- `data/verify_hashes.py`
- `release/create_release.py`

### 服务器文件
- `server/queue_handler.py`
- `server/music-queue-handler.service`
- `server/post-receive`

### 工具脚本
- `tools/analyze_duplicates.py`
- `tools/analyze_metadata.py`
- `tools/download_ytdlp.py`

### 工作目录脚本
- `work/checkout.py`
- `work/publish_meta.py`

---

**审查完成时间:** 2026-01-20  
**下一步行动:** 根据建议优先级进行改进，重点关注日志策略、传输校验和metadata校验三个核心差距。