# 规范符合性审查报告

**审查日期:** 2026-01-20  
**审查对象:** repo/ 下实现  
**对照规范:** doc/new/4库函数职责规范.md  
**审查者:** opencode

## 概述

根据《库函数职责规范》文档，对当前代码库实现进行全面审查。规范定义了路径传递与解析标准、库函数职责边界、文件系统读写原子性、远端访问校验、路径权限约定、事件返回值契约等核心规则。本报告评估实际实现与规范的符合程度，识别差距与改进建议。

---

## 1. 路径传递与解析标准

### 规范要求
- **单一入口解析**: CLI在启动时读取config.yaml并构建Context，包含所有路径（projectroot、workdir、cachedir、releasedir、logsdir、tmp_dir等）
- **绝对路径**: 所有传入库函数的路径必须是绝对路径
- **禁止库自行查找config**: 库函数不得自行读取或搜索config.yaml
- **路径验证**: CLI在注入前应做基本验证，库在执行前再次校验
- **临时路径约定**: 库写入临时文件时使用ctx.tmp_dir或tempfile.mkdtemp
- **符号链接与安全**: 库应检测并拒绝不安全的symlink

### 实现现状
⚠️ **部分符合** - 实现部分满足规范要求：
- **CLI路径解析**: `GitMusicCLI._get_path` 方法从配置读取路径并调用 `.resolve()` 确保绝对路径（cli.py:154）
- **库函数接收路径**: 库函数通常接收Path对象，但未统一通过Context注入
- **禁止自行查找配置**: 库函数不直接读取config.yaml，依赖参数传入
- **路径验证**: 缺少显式验证（存在性、权限等）
- **临时路径**: 库使用 `tempfile.mkdtemp` 或 `tempfile.mkstemp`，但未使用统一的ctx.tmp_dir
- **符号链接安全**: 未实现检测

### 关键差距
1. **缺少完整Context对象**: CLI未构建包含所有路径字段的Context对象（如project_root、work_dir、cache_dir、release_dir、logs_dir、tmp_dir等）
2. **日志目录未注入**: 规范要求的logs目录未实现，事件流未持久化到文件
3. **临时目录未统一**: 未通过Context提供tmp_dir，各库函数自行创建临时文件
4. **路径验证缺失**: 缺少写入前的目录可写性、磁盘空间检查

---

## 2. 库函数应否直接操作文件系统与远端 — 明确规则

### 规范要求
- **结论**: 是，库函数应直接操作本地文件系统与远端，但必须通过明确的抽象与契约完成
- **理由**: 集中I/O与一致性逻辑到库中，保证行为一致、便于测试
- **如何实现**: 
  - 本地I/O由objectstore、metadata、audioio等模块负责
  - 远端I/O由transport抽象负责
  - 脚本/步骤不直接做低级I/O，而是调用库API

### 实现现状
✅ **完全符合** - 实现严格遵循此原则：
- **本地I/O抽象**: `ObjectStore`、`MetadataManager`、`AudioIO` 提供统一接口（object_store.py、metadata.py、audio.py）
- **远端I/O抽象**: `TransportAdapter` 提供SCP上传下载（transport.py）
- **脚本角色**: 命令脚本（如publish.py、sync.py）调用库API，不直接操作低级I/O
- **事件与返回**: 库函数在关键步骤emit事件，但返回结构未完全标准化

### 发现
- 架构设计符合规范，实现了良好的关注点分离
- 所有文件系统和远端操作都通过库函数完成，脚本仅负责业务逻辑编排

---

## 3. 文件系统读写与原子性规范

### 规范要求
- **写入模式**: 所有对持久化目标的写入遵循：写入到临时文件 → fsync临时文件 → os.replace原子替换 → fsync目标目录
- **元数据写入锁**: 写metadata.jsonl或任何共享索引前必须获取锁
- **权限与所有权**: 写入后设置文件权限与所有者，并记录到事件
- **回滚策略**: 若写入失败应清理临时文件并emit error

### 实现现状
⚠️ **部分符合** - 实现基础原子性，但缺少完整规范：
- **原子写入**: `AudioIO.atomic_write` 使用临时文件 + `os.replace`（audio.py:220-232）
- **元数据写入**: `MetadataManager.save_all` 使用.tmp文件 + `os.replace`（metadata.py:52-58）
- **锁机制**: `MetadataManager` 有文件锁，`LockManager` 提供进程锁（locking.py）
- **缺失部分**: 
  - 未实现fsync操作（规范要求的fsync临时文件和父目录）
  - 未设置文件权限与所有者
  - 回滚策略基本实现（异常时清理临时文件）

### 关键差距
1. **缺少fsync**: 原子写入后未调用fsync确保数据落盘
2. **权限管理**: 未根据config设置文件权限和所有者
3. **目录fsync**: 未fsync父目录确保目录元数据落盘

---

## 4. 远端访问与校验规范

### 规范要求
- **抽象层**: 所有远端交互通过transport抽象
- **上传流程**: 本地写tmp → fsync → transport.upload → 远端执行sha256sum → 比对哈希 → 远端原子替换
- **下载流程**: 下载到本地.part → 本地计算哈希 → 比对期望 → mv到最终路径
- **重试与退避**: 支持可配置的重试次数、指数退避与超时
- **幂等性**: 若远端目标已存在且哈希匹配，上传操作应短路

### 实现现状
⚠️ **部分符合** - 实现基础传输，但缺少关键校验：
- **TransportAdapter**: 提供SCP上传下载，支持原子替换（transport.py:29-55）
- **重试机制**: `sync_with_retry` 函数实现指数退避重试（sync.py:103-122）
- **缺失部分**:
  - **远端哈希校验**: `TransportAdapter.upload/download` 未执行远端sha256sum校验
  - **本地哈希比对**: 下载后未验证文件完整性
  - **幂等性检查**: 仅检查本地缓存存在，不检查远端哈希匹配
  - **临时文件fsync**: 上传前未fsync本地临时文件

### 关键差距
1. **远端校验缺失**: 上传后未在远端执行sha256sum比对，不符合规范要求的传输完整性保证
2. **下载校验缺失**: 下载文件后未验证哈希
3. **幂等性不完整**: 仅基于文件路径存在性判断，未基于哈希匹配

---

## 5. 路径与权限的具体约定

### 规范要求
- **路径类型**: 库API接受Path或字符串，内部立即转换为Path并调用resolve()
- **默认目录**: 若ctx未提供某路径，库应抛出ConfigurationError
- **临时目录策略**: 优先使用ctx.tmp_dir；若不存在，使用tempfile.mkdtemp
- **权限检查**: 写入前检查目标目录可写性与磁盘空间
- **跨平台兼容**: 路径处理应兼容POSIX与Windows

### 实现现状
⚠️ **部分符合** - 实现基础路径处理：
- **路径解析**: `_get_path` 返回 `Path(...).resolve()` 确保绝对路径
- **跨平台**: 使用pathlib，兼容Windows和POSIX
- **缺失部分**:
  - **临时目录策略**: 未提供ctx.tmp_dir，各库函数自行使用tempfile
  - **权限检查**: 未检查目录可写性和磁盘空间
  - **符号链接安全**: 未检测不安全symlink
  - **默认目录错误**: 未抛出明确的ConfigurationError

### 关键差距
1. **临时目录未统一**: 缺少通过Context注入的tmp_dir
2. **安全性检查缺失**: 无目录可写性、磁盘空间、符号链接检查
3. **错误处理不精确**: 缺少ConfigurationError等具体异常类型

---

## 6. 事件、返回值与错误契约

### 规范要求
- **事件包含路径信息**: 成功写入或上传后itemevent必须包含localpath、remote_path、oid、size、permissions
- **返回结构**: 库函数返回结构化对象（例如StoreResult{audiooid, localpath, uploaded, remote_path}）
- **错误类型**: 定义明确异常类：ValidationError、IOError、TransportError、LockError
- **日志安全**: 所有事件写入运行日志，但不得写入敏感凭据

### 实现现状
⚠️ **部分符合** - 事件系统健全，但返回值和错误类型不完整：
- **EventEmitter**: 完全符合规范，提供标准事件类型和字段（events.py）
- **事件字段**: 部分事件包含路径信息，但不完整（缺少size、permissions等）
- **返回值**: 库函数返回简单类型（如字符串oid），而非结构化结果对象
- **错误类型**: 使用通用Exception，未定义规范要求的特定异常类
- **日志安全**: 未发现敏感凭据泄露问题

### 关键差距
1. **返回值未结构化**: 库函数返回简单值而非结果对象，不利于调用方处理
2. **异常类缺失**: 缺少ValidationError、TransportError等具体异常类型
3. **事件字段不完整**: 缺少size、permissions等元数据

---

## 7. 实施与验收检查清单

### 规范检查清单对照

| 检查项 | 规范要求 | 实现现状 | 状态 |
|--------|----------|----------|------|
| 路径注入 | CLI是否把projectroot、workdir、cachedir、releasedir、logsdir、tmpdir注入Context？ | CLI注入部分路径，但缺少logsdir、tmpdir | ⚠️ 部分符合 |
| 绝对路径 | 库函数接收到的路径是否为绝对路径？ | 是，通过`_get_path().resolve()` | ✅ 符合 |
| 临时写入 | 所有写操作是否遵循 tmp -> fsync -> mv -> fsync(parent)？ | tmp -> mv，但缺少fsync | ⚠️ 部分符合 |
| 锁使用 | metadata写入是否在锁保护下？ | 是，使用MetadataManager或LockManager锁 | ✅ 符合 |
| 远端校验 | 上传后是否做远端 sha256 校验并比对本地？ | 否，TransportAdapter未实现远端校验 | ❌ 不符合 |
| 幂等性 | 重复 store_audio 对相同 oid 是否短路？ | 仅检查本地文件存在，不检查远端哈希 | ⚠️ 部分符合 |
| 错误事件 | 库在失败前是否 emit error 并抛出明确异常？ | emit error，但抛出通用异常 | ⚠️ 部分符合 |
| 权限检查 | 写入前是否检查目录可写性与磁盘空间？ | 否，未实现 | ❌ 不符合 |
| 日志敏感信息 | 日志中是否避免写入凭据或密钥？ | 是，未发现敏感信息泄露 | ✅ 符合 |

---

## 总结与建议

### 总体评价
当前实现 **部分符合** 库函数职责规范，核心架构正确，模块职责清晰，事件系统健全。主要差距集中在 **远端传输完整性校验**、**完整Context注入**、**原子写入完整性** 和 **结构化返回值**。

### 关键差距
1. **远端校验缺失** - TransportAdapter未实现上传后的远端SHA256校验，不符合规范要求的传输完整性保证
2. **Context不完整** - CLI未构建包含所有路径字段的Context对象，缺少logs_dir、tmp_dir等
3. **原子写入不完整** - 缺少fsync操作，可能影响数据持久性
4. **返回值未结构化** - 库函数返回简单类型而非结构化结果对象
5. **临时目录未统一** - 各库函数自行创建临时文件，未使用统一的ctx.tmp_dir

### 高优先级建议
1. **实现远端哈希校验** - 在TransportAdapter中添加上传后的远端sha256sum校验，确保传输完整性
2. **完善Context对象** - 在CLI中构建完整Context，包含所有规范要求的路径字段
3. **补充fsync操作** - 在原子写入中添加fsync临时文件和父目录调用
4. **统一临时目录管理** - 通过Context提供tmp_dir，库函数优先使用该目录

### 中优先级建议
5. **结构化返回值** - 定义StoreResult等结果类，库函数返回结构化对象而非简单值
6. **定义具体异常类** - 实现ValidationError、TransportError等规范要求的异常类型
7. **实现权限检查** - 添加目录可写性、磁盘空间、符号链接安全检查
8. **日志持久化** - 实现事件流写入logs/<command>-TIMESTAMP.jsonl文件

### 低优先级建议
9. **完善事件字段** - 确保所有item_event包含localpath、remote_path、size、permissions等完整信息
10. **实现文件权限设置** - 根据config设置文件权限和所有者

---

## 附录：文件清单

### 核心审查文件
- `tools/cli.py` - CLI主程序，路径注入与Context构建
- `libgitmusic/` - 核心库模块
  - `audio.py` - 音频I/O与原子写入
  - `metadata.py` - 元数据管理
  - `object_store.py` - 对象存储
  - `transport.py` - 传输适配器（关键差距）
  - `hash_utils.py` - 哈希计算
  - `locking.py` - 锁管理
  - `events.py` - 事件系统
  - `commands/` - 各命令逻辑
- `config.yaml` - 配置文件

### 关键代码位置
- 路径解析：`cli.py:154` (`_get_path`方法)
- 原子写入：`audio.py:220-232` (`atomic_write`方法)
- 传输适配器：`transport.py:29-55` (`upload`/`download`方法)
- 事件发射：`events.py:25-50` (`emit`方法)
- 锁管理：`locking.py:29-86` (`acquire_file_lock`方法)

---

**审查完成时间:** 2026-01-20  
**下一步行动:** 根据建议优先级进行改进，重点关注远端校验和Context完善。