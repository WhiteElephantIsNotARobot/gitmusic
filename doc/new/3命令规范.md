概览
本报告以命令为中心，在单一运行时架构下把你提供的命令规范与脚本规范映射为可执行的实现设计。核心决策：所有业务逻辑由库 libgitmusic 提供；cli.py 负责命令注册、工作流编排、事件订阅、终端渲染与日志持久化；交互模式渲染人类可读输出，服务端模式仅输出 JSONL 日志。下面逐条列出每个命令的完整实现意图、必需参数、工作流步骤、关键事件、锁策略与失败策略；随后给出脚本到库函数的映射与最小库接口清单；最后说明事件与 I O 标准、测试与迁移要点、交付物。

---

执行模型
运行时模型  
- 单一进程主控：cli.py 在单进程内按步骤调用库函数，步骤可在线程池或协程中并发执行。  
- 事件驱动：库在关键点通过 events.emit() 写入 JSONL 事件；cli.py 订阅事件并在 interactive 模式渲染人类可读输出；在 log-only 模式事件以 JSONL 写 stdout。  
- 锁与原子性：metadata 写入与共享索引操作由 locking 管理；所有写操作采用临时文件并原子替换。  
- 错误策略：每个命令定义 on_error 策略（默认 stop）；步骤遇不可恢复错误先 emit error 再抛异常，cli.py 按策略处理。

---

命令规范 一致实现（按原文逐条覆盖）

publish
目的  
发布 work 目录改动到库，生成字段级 diff，完成对象写入、封面压缩、哈希校验、同步上传与 metadata 提交。

必需参数与选项  
- --changed-only 仅处理有变动的文件  
- --preview 仅显示预览，不执行发布

工作流步骤  
1. scan_work 列出 work 目录文件并读取嵌入标签。  
   - 事件 phasestart itemevent(found)  
2. diffwithmetadata 与 metadata.jsonl 比对，标注 NEW/MOD/SAME 并生成字段级 diff。  
   - 事件 itemevent(diffpreview)  
3. previewandconfirm CLI 渲染预览表格并等待用户确认；若 --preview 则退出并返回预览。  
4. hashandstoreaudio 提取音频流、计算音频帧哈希、写入 objectstore（本地并上传远端）。  
   - 锁 在需要写 metadata 前获取写锁  
   - 事件 phasestart(hashstore) batchprogress itemevent(audio_stored)  
5. compressandstorecover 提取并压缩封面，写入 objectstore。  
   - 事件 itemevent(coverstored)  
6. validateandverify 本地与远端哈希校验，失败终止命令。  
   - 事件 itemevent(verifyok) 或 error  
7. updatemetadatacommit 在持锁下更新 metadata.jsonl 并 commit 推送。  
   - 事件 phase_start(commit) result(summary)

失败策略  
- 默认 on_error=stop；校验失败或远端不一致为致命错误并中止。

---

checkout
目的  
从 cache 检出音频到 work，嵌入最新元数据與封面，并写入 METADATA_HASH 标签。

必需参数与选项  
- <query> 搜索关键词（默认在所有字段搜索）  
- --missing <fields> 按缺失字段过滤  
- --force 或 -f 强制覆盖 work 已有文件  
- --limit <n> 限制处理数量  
- --search-field <field> 仅在指定字段搜索  
- --line <n> 按行号过滤输出，短参数 -l

工作流步骤  
1. query_metadata 根据 query/filters 返回候选条目。  
   - 事件 phasestart itemevent(candidate)  
2. conflict_check 检查 work 目录冲突；若冲突且无 -f，CLI 自动连锁调用 publish --preview 并退出。  
   - 事件 log 或 error  
3. fetchobjects 从 objectstore 下载 audio 与 cover 到临时位置。  
   - 事件 batchprogress itemevent(fetched)  
4. embedmetadata 将元数据与封面嵌入音频并写回 work，写入 METADATAHASH 标签。  
   - 事件 itemevent(wrotefile)

失败策略  
- 冲突时默认退出并提示；下载失败按 on_error 策略处理。

---

release
目的  
生成成品库，支持增量生成与 local/server 模式。

必需参数与选项  
- --mode <local|server> 运行模式，默认 local  
- --force 或 -f 生成前清空目标目录  
- --line 或 -l <n> 按行号生成，支持范围 xx-xx  
- --workers <n> 并行线程数，默认 1

工作流步骤  
1. git_pull 在 server 模式下执行 git pull（可选）。  
   - 事件 log  
2. preparelist 根据 METADATAHASH 或 --line 生成待处理列表（增量逻辑）。  
   - 事件 phasestart itemevent(listed)  
3. sync_cache 确保对象本地可用，缺失则下载。  
   - 事件 batch_progress  
4. generatereleasefiles 嵌入标签、必要时转码、原子写入 release 目录。  
   - 事件 itemevent(releasewritten) batch_progress  
5. verify_release 生成后校验成品完整性。  
   - 事件 itemevent(verifyok) 或 error  
6. summaryandpublish 可选推送或更新索引并输出 summary。  
   - 事件 result(summary)

失败策略  
- 默认 on_error=continue 可在遇单项错误时继续生成其余项，最终在 summary 报告错误。

---

sync
目的  
双向增量同步本地 cache 与远端 data。

必需参数与选项  
- --direction <upload|download|both> 同步方向，默认 both  
- --dry-run 仅显示差异，不执行同步  
- --timeout <n> 单个文件超时时间  
- --workers <n> 并行线程数

别名  
- push 等价 sync --direction=upload  
- pull 等价 sync --direction=download

工作流步骤  
1. scanlocalremote_index 列出本地与远端 oid。  
   - 事件 phase_start  
2. diffandplan 计算上传/下载计划。  
   - 事件 log itemevent(planitem)  
3. execute_plan 执行上传/下载，带重试与指数退避。  
   - 事件 batchprogress itemevent(uploaded/downloaded)  
4. summary 输出同步摘要。  
   - 事件 result(summary)

失败策略  
- 传输失败按重试策略处理，超时或多次失败按 on_error 决定是否继续。

---

verify
目的  
校验 cache 或 release 中文件的 SHA256 完整性。

必需参数与选项  
- --mode <data|release> 校验模式  
- --delete 自动删除无法匹配或哈希错误的文件（移动到回收站）

工作流步骤  
1. collect_targets 构建待校验列表。  
   - 事件 phase_start  
2. computeandcompare 重新计算 SHA256 并与期望值比较。  
   - 事件 batchprogress itemevent(verifyok|verifyfail)  
3. optional_delete 若 --delete 将坏文件移动到回收站并 emit 事件。  
   - 事件 item_event(deleted)  
4. summary 输出结果。  
   - 事件 result(summary)

失败策略  
- 校验失败记录为 error 或 warn，--delete 为破坏性操作需谨慎确认。

---

cleanup
目的  
识别并可选清理孤立对象，支持本地与远端双端清理。

必需参数与选项  
- --mode <local|server|both> 清理模式  
- --confirm 必须指定才执行删除

工作流步骤  
1. buildreferencetable 从 metadata 生成引用表。  
   - 事件 phase_start  
2. scan_objects 列出本地与远端对象。  
   - 事件 log  
3. compute_orphans 计算孤立对象集合。  
   - events item_event(orphan)  
4. reportordelete 若 --confirm 执行删除并 emit summary。  
   - events result(summary)

失败策略  
- 默认仅报告；删除需 --confirm 才执行，避免误删。

---

download
目的  
使用 yt-dlp 下载音频并更新库，支持批处理与元数据预览。

必需参数与选项  
- <URL> 下载地址  
- --batch-file <path> 批量下载文件路径（txt）  
- --fetch 仅获取元数据预览（不下载）  
- --no-preview 隐藏元数据预览

工作流步骤  
1. fetch_metadata 若 --fetch 或预览阶段，调用 yt-dlp 获取元数据并 emit 预览事件。  
   - events item_event(preview)  
2. download_media 调用 yt-dlp 下载音频并捕获原始输出映射为 progress 事件。  
   - events progress item_event(downloaded)  
3. compresscover 压缩封面并写入 objectstore。  
   - events itemevent(coverstored)  
4. verifyandsync 校验哈希并同步缓存，最后 commit metadata。  
   - events result(summary)

失败策略  
- 下载或校验失败为致命错误并中止当前项，批量模式继续处理其他项。

---

analyze
目的  
分析 metadata，支持搜索、过滤、字段提取与统计。

必需参数与选项  
- <query> 搜索关键词  
- --search-field <field> 指定字段搜索  
- --line <n> 按行号过滤，短参数 -l  
- --read <fields> 提取指定字段  
- --missing <field> 过滤缺失字段条目  
- --filter <fields> 输出时过滤字段  
- --limit <n> 限制输出数量，默认 10

工作流步骤  
1. query_index 执行搜索与过滤。  
   - events phasestart itemevent(match)  
2. compute_stats 生成统计信息并输出。  
   - events result(stats)

失败策略  
- 查询参数错误返回 error 并退出。

---

compress_images
目的  
压缩封面图片以优化体积并在哈希变化时更新 metadata。

必需参数与选项  
- --size <n> 压缩阈值，支持单位 kb mb gb，默认单位 kb

工作流步骤  
1. scan_covers 列出大于阈值的封面。  
   - events phase_start  
2. compress_each 使用 ffmpeg 压缩并计算新哈希。  
   - events item_event(compressed)  
3. updatemetadataif_changed 若哈希变化更新 metadata 并 commit。  
   - events result(summary)

失败策略  
- 压缩失败记录 warn 并继续，更新 metadata 失败为 error 并停止相关项。

---

脚本到库函数映射 最小接口清单
设计原则  
- 库函数不暴露过多实现细节，仅提供命令所需的最小接口；cli.py 以这些接口构建工作流。  
- 所有库函数在关键点调用 events.emit() 写事件并返回结构化结果或抛出明确异常。

最小接口示例  
- work.scanwork(workdir) -> Iterable[WorkItem]  
- metadata.diff_items(items) -> Iterable[DiffItem]  
- audio.hashandstore(item, ctx) -> StoreResult  
- audio.process_cover(item, ctx) -> CoverResult  
- hash.verifylocalandremote(audiooid, ctx) -> VerifyResult  
- metadata.addorupdateandcommit(entries, message, ctx) -> CommitResult  
- objectstore.ensurelocal(oids, ctx) -> EnsureResult  
- release.generate(item, out_dir, ctx) -> ReleaseResult  
- sync.plan(localindex, remoteindex) -> SyncPlan  
- sync.execute(plan, ctx) -> SyncResult  
- verify.check(item, ctx) -> VerifyResult  
- cleanup.find_orphans(ctx) -> List[Oid]  
- download.fetch_metadata(url) -> MetadataPreview  
- download.run(url, out_dir, ctx) -> DownloadResult  
- events.emit(event: dict) -> None  
- locking.acquire(name, timeout) -> LockHandle locking.release(handle) -> None

---

事件与 I O 标准（简洁）
事件类型  
- phasestart batchprogress progress item_event log result error summary

事件字段要求  
- 每条事件包含 ts cmd type；按类型补充 phase processed total_items id status message artifacts 等。

I O 约定  
- interactive：cli.py 订阅事件并渲染人类可读输出；不在终端打印 JSON。  
- log-only：事件以 JSONL 写 stdout（每行一条事件），并可同时写入日志文件。  
- 日志文件：<logs_dir>/<command>-YYYYMMDD-HHMMSS.jsonl。

---

测试 迁移 与交付
迁移顺序  
1. 冻结命令接口与最小库 API。  
2. 实现 events.emit() 与日志持久化。  
3. 实现 cli.py 命令注册骨架与 interactive 渲染。  
4. 实现 MetadataManager 與 LockManager 并单元测试。  
5. 实现 object_store 与 ScpAdapter 并做端到端上传校验。  
6. 逐命令替换脚本为库步骤，优先 publish、release、sync。  
7. 全量回归测试与性能调优。

测试矩阵要点  
- 单元测试覆盖字段校验、hash、object_store 幂等性、transport 重试。  
- 集成测试覆盖每个命令的完整工作流（小样本与 500+ 全量）。  
- 故障注入测试网络中断、远端哈希不一致、缺封面、文件名冲突。  
- 验收条件包括正确 metadata 写入、远端校验通过、interactive 输出美观且不打印 JSON、log-only 输出 JSONL。

交付物  
- cli.py 命令注册与工作流骨架（含 rich 渲染）  
- libgitmusic 最小接口模块骨架与文档（命令映射清单）  
- config.example.yaml（含 logs_dir、transport、ffmpeg 参数）  
- 测试用例模板与小样本数据集

---

结语
本报告严格以你提供的命令实现规范为准，逐条列出每个命令的完整工作流、必需选项、关键事件、锁与失败策略，并给出最小库接口映射以便实现。命令参数没有增减或遗漏；库函数设计保持精简以便实现与测试。