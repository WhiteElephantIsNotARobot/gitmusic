# GitMusic 目录结构差距分析报告

**报告日期**: 2026-01-31
**参考规范**: `doc/new/6目录结构与开源配置规范.md`
**当前状态**: v2.0 生产就绪

---

## 一、概述

本报告基于 **6号规范文档**（`doc/new/6目录结构与开源配置规范.md`）对当前 GitMusic 项目进行目录结构对比分析，识别差距并提供重构建议。

### 1.1 规范核心设计原则

| 原则 | 说明 |
|------|------|
| **单一真相** | 每项功能的实现只在一个位置声明 |
| **职责分层** | CLI层 → 命令层 → 核心库层 → UI层 |
| **可替换性** | UI、transport、locking 等通过抽象接口实现 |
| **可测试性** | 每个命令与核心函数都可独立单元测试 |

### 1.2 当前项目状态

- **版本**: v2.0
- **状态**: 生产就绪
- **架构**: 事件驱动架构
- **CLI**: Rich + prompt_toolkit 双模式（interactive / log-only）

---

## 二、目录结构对比

### 2.1 规范要求的目录结构

```
gitmusic/
├── pyproject.toml              # 项目构建与依赖声明
├── config.example.yaml         # 示例配置
├── README.md / LICENSE         # 项目说明与许可证
├── gitmusic.ps1                # PowerShell 启动脚本
├── src/gitmusic/               # 源代码包
│   ├── cli.py                  # 主入口（Context构建、命令注册、事件订阅）
│   ├── commands/               # 命令模块（publish.py, checkout.py 等）
│   │   └── register(registry)  # 每个模块导出 register
│   ├── core/                   # 核心业务实现
│   │   ├── object_store.py     # 本地 cache 管理
│   │   ├── metadata.py         # metadata.jsonl 管理
│   │   ├── transport.py        # 远端传输抽象
│   │   ├── locking.py          # 文件/进程锁
│   │   ├── audio.py            # 音频 I/O
│   │   ├── hash_utils.py       # 哈希计算
│   │   ├── git.py              # git 操作封装
│   │   ├── context.py          # 运行时 Context
│   │   └── events.py           # EventEmitter
│   ├── ui/                     # 渲染层
│   │   ├── renderer.py         # UIRenderer 抽象基类
│   │   ├── rich_renderer.py    # RichUIRenderer
│   │   ├── noop_renderer.py    # NoopUIRenderer
│   │   └── table_registry.py   # TableStyleRegistry
│   └── exceptions.py           # 自定义异常类型
├── docs/                       # 文档
│   ├── command-spec.md         # 命令规范
│   ├── OPERATION.md            # 操作手册
│   └── TROUBLESHOOTING.md      # 故障排查
├── tests/                      # 单元与集成测试
│   ├── conftest.py             # 测试桩与 mock transport
│   └── ...
└── archive/                    # 废弃脚本与历史文档
```

### 2.2 当前实际的目录结构

```
gitmusic/
├── .github/                    # GitHub 配置
├── .vscode/                    # VS Code 配置
├── assets/                     # 静态资源
├── archive/                    # 归档文件（旧脚本）
├── doc/                        # 文档
│   ├── OPERATION.md
│   ├── TROUBLESHOOTING.md
│   ├── command-spec.md
│   └── new/                    # 新规范文档
│       ├── 1CLI架构规范.md
│       ├── 2CLI视觉规范&库规范.md
│       ├── 3命令规范.md
│       ├── 4库函数职责规范.md
│       ├── 5CLI命令&UI渲染技术规范.md
│       └── 6目录结构与开源配置规范.md
├── repo/                       # Git 仓库（核心代码）
│   ├── metadata.jsonl         # 核心元数据文件
│   ├── libgitmusic/           # 核心库代码
│   │   ├── __init__.py
│   │   ├── commands/          # 命令实现
│   │   ├── context.py
│   │   ├── events.py
│   │   ├── exceptions.py
│   │   ├── git.py
│   │   ├── hash_utils.py
│   │   ├── locking.py
│   │   ├── metadata.py
│   │   ├── object_store.py
│   │   ├── results.py
│   │   ├── transport.py
│   │   └── audio.py
│   ├── tools/                 # 工具脚本
│   │   ├── cli.py             # CLI 入口（主程序）
│   │   ├── analyze_duplicates.py
│   │   ├── analyze_metadata.py
│   │   └── download_ytdlp.py
│   ├── work/                  # 工作目录（待发布音频）
│   ├── data/                  # 数据处理脚本
│   ├── release/               # 发布目录
│   └── server/                # 服务器配置
├── tests/                     # 测试套件
│   ├── integration/           # 集成测试
│   └── unit/                  # 单元测试
├── work/                      # 工作目录（待发布音频）
├── cache/                     # 对象缓存
├── release/                   # 成品音乐库
├── logs/                      # 事件日志
├── config.example.yaml        # 配置示例
├── config.yaml                # 用户配置（未提交）
├── gitmusic.ps1               # PowerShell 启动脚本
├── LICENSE
├── README.md
├── pytest.ini
└── test_runner.py
```

---

## 三、差距分析

### 3.1 顶层文件对比

| 文件/目录 | 规范要求 | 当前状态 | 差距说明 |
|-----------|----------|----------|----------|
| `pyproject.toml` | ✅ 必需 | ❌ 缺失 | 使用 `requirements.txt` 或其他方式管理依赖 |
| `config.example.yaml` | ✅ 必需 | ✅ 存在 | 符合规范 |
| `README.md` | ✅ 必需 | ✅ 存在 | 符合规范 |
| `LICENSE` | ✅ 必需 | ✅ 存在 | GPL-3.0 |
| `gitmusic.ps1` | ✅ 必需 | ✅ 存在 | PowerShell 启动脚本 |

**差距**: 缺少 `pyproject.toml`，建议迁移到 PEP 621 标准。

---

### 3.2 源代码包结构对比

#### 3.2.1 CLI 层

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `src/gitmusic/cli.py` | `repo/tools/cli.py` | **路径不符** |
| 职责: Context构建、命令注册、事件订阅 | 基本符合 | 但职责分散在多个类中 |

**差距**:
1. **路径不符**: CLI 入口在 `repo/tools/cli.py` 而非 `src/gitmusic/cli.py`
2. **命名空间**: 当前使用 `libgitmusic` 作为包名，而非 `gitmusic`

---

#### 3.2.2 命令层

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `src/gitmusic/commands/` | `repo/libgitmusic/commands/` | **路径不符** |
| 每个命令一个模块 | ✅ 符合 | publish, checkout, sync, verify, cleanup, release, analyze, download, compress_images |
| 导出 `register(registry)` | ❌ 不符合 | 当前直接导入使用，无注册机制 |

**差距**:
1. **路径不符**: 命令模块在 `repo/libgitmusic/commands/`
2. **注册机制**: 缺少统一的命令注册表，当前在 `cli.py` 中直接导入命令模块

---

#### 3.2.3 核心库层

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `src/gitmusic/core/` | `repo/libgitmusic/` | **路径不符** |
| `object_store.py` | ✅ 存在 | 符合规范 |
| `metadata.py` | ✅ 存在 | 符合规范 |
| `transport.py` | ✅ 存在 | 符合规范 |
| `locking.py` | ✅ 存在 | 符合规范 |
| `audio.py` | ✅ 存在 | 符合规范 |
| `hash_utils.py` | ✅ 存在 | 符合规范 |
| `git.py` | ✅ 存在 | 符合规范 |
| `context.py` | ✅ 存在 | 符合规范 |
| `events.py` | ✅ 存在 | 符合规范 |
| `results.py` | ✅ 存在 | **规范未要求** |

**差距**:
1. **路径不符**: 核心模块在 `repo/libgitmusic/` 而非 `src/gitmusic/core/`
2. **额外模块**: `results.py` 是当前实现的额外模块

---

#### 3.2.4 UI 层

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `src/gitmusic/ui/` | ❌ 缺失 | **严重差距** |
| `renderer.py` (UIRenderer抽象) | ❌ 缺失 | 当前直接在 `cli.py` 中使用 Rich |
| `rich_renderer.py` | ❌ 缺失 | 未实现独立的渲染器类 |
| `noop_renderer.py` | ❌ 缺失 | 未实现 |
| `table_registry.py` | ❌ 缺失 | 未实现 |

**差距**:
- **严重**: 缺少独立的 UI 渲染层，当前渲染逻辑直接耦合在 `cli.py` 中
- **不符合** "单一渲染入口" 原则

---

#### 3.2.5 异常处理

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `src/gitmusic/exceptions.py` | `repo/libgitmusic/exceptions.py` | **路径不符** |
| 自定义异常类型 | ✅ 符合 | GitMusicError, ValidationError, TransportError 等 |

**差距**: 路径不符，但功能符合规范。

---

### 3.3 文档与测试

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `docs/` | `doc/` | **目录名不符** |
| `command-spec.md` | ✅ 存在 | 符合规范 |
| `OPERATION.md` | ✅ 存在 | 符合规范 |
| `TROUBLESHOOTING.md` | ✅ 存在 | 符合规范 |
| `tests/` | ✅ 存在 | 符合规范 |
| `conftest.py` | ✅ 存在 | 符合规范 |
| `archive/` | ✅ 存在 | 符合规范 |

**差距**:
1. **目录名不符**: 文档目录为 `doc/` 而非 `docs/`
2. **新规范文档**: `doc/new/` 包含了 6 个新规范文档，但未完全落地

---

### 3.4 配置与路径约定

#### 3.4.1 配置加载

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| CLI 读取 `GITMUSIC_CONFIG` | ✅ 符合 | `cli.py` 支持配置路径 |
| 默认 `project_root/config.yaml` | ✅ 符合 | 支持默认路径 |
| 构建 `Context` 并解析为绝对路径 | ✅ 符合 | `create_context()` 实现 |

**差距**: 基本符合规范。

---

#### 3.4.2 Context 内容

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `project_root` | ✅ 存在 | `context.project_root` |
| `work_dir` | ✅ 存在 | `context.work_dir` |
| `cache_dir` | ✅ 存在 | `context.cache_root` |
| `release_dir` | ✅ 存在 | `context.release_dir` |
| `logs_dir` | ✅ 存在 | `context.logs_dir` |
| `tmp_dir` | ❌ 缺失 | 未定义 |
| `transport` | ✅ 存在 | `context.transport_config` |
| `events` | ✅ 存在 | `EventEmitter` |
| `ui` | ❌ 缺失 | 未注入 UI 渲染器 |
| `executor` | ❌ 缺失 | 未定义 |
| `mode` | ❌ 缺失 | 未定义（interactive/log-only） |

**差距**:
1. **缺少**: `tmp_dir`, `ui`, `executor`, `mode`
2. **当前实现**: `log_only` 作为 CLI 参数，未在 Context 中统一管理

---

#### 3.4.3 临时文件与原子写入

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `write to tmp → fsync → os.replace → fsync(parent)` | ⚠️ 部分符合 | 需要检查具体实现 |
| 写入 metadata 前必须 acquire lock | ✅ 符合 | `LockManager` 实现 |

**差距**: 需要验证原子写入的具体实现是否完全符合规范。

---

#### 3.4.4 远端传输

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `transport` 抽象 | ✅ 存在 | `TransportAdapter` |
| 上传流程: `local_tmp → upload → remote_sha256 → compare → remote_move` | ⚠️ 需要验证 | 需要检查具体实现 |
| 支持重试与指数退避 | ✅ 符合 | `retries` 配置 |

**差距**: 需要验证上传流程是否完全符合规范。

---

#### 3.4.5 日志

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `logs_dir/<command>-YYYYMMDD-HHMMSS.jsonl` | ✅ 符合 | `EventEmitter.setup_logging()` |
| JSONL 格式: `ts, cmd, type, phase, id, status, message, artifacts` | ✅ 符合 | `EventEmitter` 实现 |
| interactive 模式不打印 JSON | ✅ 符合 | `log_only` 参数控制 |
| log-only 模式事件写 stdout | ✅ 符合 | `log_only` 模式输出 JSONL |

**差距**: 基本符合规范。

---

### 3.5 UI 标准与样式注册

#### 3.5.1 单一渲染入口

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| 命令只调用 `ctx.ui` 的方法 | ❌ 不符合 | 命令直接使用 `EventEmitter` 和 Rich |
| 不直接使用 `rich` | ❌ 不符合 | `cli.py` 直接使用 Rich 渲染 |

**差距**: **严重** - 缺少 UI 抽象层，渲染逻辑耦合在 CLI 中。

---

#### 3.5.2 TableSpec 与 TableStyleRegistry

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `TableStyleRegistry` 集中定义表格样式 | ❌ 缺失 | 表格样式在 `cli.py` 中硬编码 |
| 命令通过样式 id 请求渲染 | ❌ 不符合 | 直接创建 Table 对象 |

**差距**: 缺少样式注册机制。

---

#### 3.5.3 进度策略

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| 批量任务使用聚合进度条 | ✅ 符合 | `Progress` 组件 |
| 短任务合并为 batch updates | ✅ 符合 | `batch_progress` 事件 |
| 长任务发 `progress` 事件 | ✅ 符合 | `progress` 事件 |

**差距**: 基本符合规范。

---

#### 3.5.4 运行模式处理

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `ctx.mode` 决定注入 `RichUIRenderer` 或 `NoopUIRenderer` | ❌ 不符合 | `log_only` 作为 CLI 参数 |
| 命令仅在必要交互点检查 `ctx.mode` | ❌ 不符合 | 多处检查 `log_only` |

**差距**: 模式处理未在 Context 中统一管理。

---

#### 3.5.5 可测试渲染

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| 提供 `CaptureUIRenderer` 用于断言 | ❌ 缺失 | 未实现 |

**差距**: 缺少测试用的渲染器。

---

### 3.6 打包、发布与 CI 配置

#### 3.6.1 打包

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| 使用 `pyproject.toml` (PEP 621) | ❌ 缺失 | 未实现 |
| 包名 `gitmusic` | ⚠️ 部分符合 | 当前使用 `libgitmusic` |
| 入口点 `gitmusic=gitmusic.cli:main` | ⚠️ 部分符合 | 当前入口在 `repo/tools/cli.py` |

**差距**:
1. **缺少**: `pyproject.toml`
2. **包名不符**: 当前为 `libgitmusic` 而非 `gitmusic`
3. **入口点不符**: 当前入口在 `repo/tools/cli.py`

---

#### 3.6.2 CI 流程

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| GitHub Actions | ✅ 存在 | `.github/` 目录 |
| 静态检查 (ruff/flake8) | ⚠️ 需要配置 | 未明确配置 |
| 类型检查 (mypy) | ⚠️ 需要配置 | 未明确配置 |
| 单元测试 | ✅ 符合 | `tests/unit/` |
| 集成测试 | ✅ 符合 | `tests/integration/` |
| 构建 wheel | ❌ 缺失 | 未实现 |
| 发布到 PyPI | ❌ 缺失 | 未实现 |

**差距**:
1. **缺少**: 静态检查、类型检查的 CI 配置
2. **缺少**: 构建和发布流程

---

#### 3.6.3 Release 策略

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| 语义化版本控制 | ✅ 符合 | v2.0 |
| 发布前运行全量集成测试 | ⚠️ 需要验证 | 有集成测试，但未在 CI 中自动化 |
| 生成变更日志 | ❌ 缺失 | 未提供 `CHANGELOG.md` |

**差距**:
1. **缺少**: `CHANGELOG.md`
2. **CI**: 需要配置全量集成测试

---

#### 3.6.4 容器化

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| Dockerfile | ❌ 缺失 | 未提供 |
| systemd unit 示例 | ❌ 缺失 | 未提供 |
| `--log-only` 模式 | ✅ 符合 | 已实现 |

**差距**:
1. **缺少**: Dockerfile
2. **缺少**: systemd unit 示例

---

### 3.7 测试、迁移与验收

#### 3.7.1 迁移步骤

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| 1. 冻结公共 API | ⚠️ 部分符合 | API 基本稳定 |
| 2. 实现 `events.emit()` | ✅ 符合 | `EventEmitter` 已实现 |
| 3. 实现 `UIRenderer` | ❌ 缺失 | 未实现 |
| 4. 实现 `CommandRegistry` | ❌ 缺失 | 未实现 |
| 5. 逐个迁移命令 | ✅ 符合 | 命令已实现 |
| 6. 全量回归与性能调优 | ⚠️ 部分符合 | 有测试，但未完全自动化 |

**差距**:
1. **缺少**: `UIRenderer` 抽象层
2. **缺少**: `CommandRegistry` 命令注册表

---

#### 3.7.2 测试矩阵

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| 单元测试覆盖核心模块 | ✅ 符合 | `tests/unit/` |
| 命令模块使用 mock ctx | ⚠️ 部分符合 | 需要验证 |
| 集成测试覆盖 end-to-end | ✅ 符合 | `tests/integration/` |
| 故障注入测试 | ✅ 符合 | `tests/integration/test_failure_injection.py` |

**差距**: 基本符合规范。

---

#### 3.7.3 验收标准

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| interactive 模式渲染美观 | ✅ 符合 | Rich 渲染 |
| log-only 模式输出 JSONL | ✅ 符合 | 已实现 |
| metadata 写入原子且远端校验 | ⚠️ 需要验证 | 需要验证具体实现 |
| 全量运行错误率在可接受范围 | ⚠️ 需要验证 | 需要实际运行测试 |

**差距**: 需要验证原子写入和远端校验。

---

### 3.8 开源项目治理与贡献指南

#### 3.8.1 贡献流程

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| Fork → feature branch → PR | ✅ 符合 | README 中有说明 |
| CI 通过 → 代码审查 → 合并 | ⚠️ 部分符合 | 需要完善 CI |

**差距**: CI 需要完善。

---

#### 3.8.2 代码风格

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| PEP8、类型注解、docstring | ⚠️ 部分符合 | 需要验证 |
| pre-commit 钩子 (ruff、black、isort) | ❌ 缺失 | 未配置 |

**差距**:
1. **缺少**: pre-commit 配置
2. **需要验证**: 类型注解和 docstring 覆盖率

---

#### 3.8.3 文档

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| `docs/` 包含命令规范、操作手册、故障排查 | ✅ 符合 | `doc/` 目录 |
| 变更需同步更新 `command-spec.md` | ⚠️ 需要验证 | 需要流程保证 |

**差距**: 需要建立文档更新流程。

---

#### 3.8.4 安全与凭据

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| SSH 私钥与敏感配置不入库 | ✅ 符合 | `.gitignore` 中排除 |
| 示例凭据放在 `config.example.yaml` | ✅ 符合 | 已提供 |
| 实际凭据由运维管理 | ⚠️ 需要验证 | 用户自行管理 |

**差距**: 基本符合规范。

---

#### 3.8.5 版本与发布

| 规范要求 | 当前状态 | 差距说明 |
|----------|----------|----------|
| 语义化版本 | ✅ 符合 | v2.0 |
| 发布时更新 `CHANGELOG.md` | ❌ 缺失 | 未提供 |
| release notes 列出迁移步骤 | ❌ 缺失 | 未提供 |

**差距**:
1. **缺少**: `CHANGELOG.md`
2. **缺少**: release notes 模板

---

## 四、差距总结

### 4.1 严重差距（必须解决）

| 优先级 | 问题 | 影响 |
|--------|------|------|
| **P0** | 缺少 UI 渲染层 (`src/gitmusic/ui/`) | 不符合架构分层原则，渲染逻辑耦合 |
| **P0** | 缺少命令注册表 (`CommandRegistry`) | 不符合 "单一真相" 原则 |
| **P0** | 路径结构不符 (`repo/libgitmusic/` vs `src/gitmusic/`) | 影响包分发和命名空间 |
| **P0** | 缺少 `pyproject.toml` | 无法通过 pip 安装 |

### 4.2 重要差距（建议解决）

| 优先级 | 问题 | 影响 |
|--------|------|------|
| **P1** | 缺少 `CHANGELOG.md` | 不符合开源项目规范 |
| **P1** | 缺少 pre-commit 钩子 | 代码风格不统一 |
| **P1** | CI 缺少静态检查和类型检查 | 代码质量无法保证 |
| **P1** | 缺少 Dockerfile 和 systemd unit | 部署不便 |
| **P1** | 缺少 `CaptureUIRenderer` | 测试覆盖不完整 |

### 4.3 中等差距（可选解决）

| 优先级 | 问题 | 影响 |
|--------|------|------|
| **P2** | 文档目录名不符 (`doc/` vs `docs/`) | 命名不一致 |
| **P2** | 缺少 `tmp_dir` 在 Context 中 | 临时文件管理不统一 |
| **P2** | 缺少 `executor` 和 `mode` 在 Context 中 | 运行时状态管理不统一 |
| **P2** | 缺少 TableStyleRegistry | 表格样式硬编码 |
| **P2** | 缺少构建和发布到 PyPI 的 CI | 无法自动发布 |

### 4.4 需要验证的差距

| 问题 | 验证方法 |
|------|----------|
| 原子写入是否符合规范 | 检查 `metadata.py` 和 `object_store.py` 的写入逻辑 |
| 远端传输流程是否符合规范 | 检查 `transport.py` 的上传流程 |
| 命令模块使用 mock ctx | 检查 `tests/unit/` 测试用例 |
| metadata 写入原子且远端校验 | 运行集成测试验证 |

---

## 五、重构建议

### 5.1 短期重构（1-2 周）

#### 5.1.1 目录结构调整

```bash
# 1. 重命名目录
mv repo/libgitmusic src/gitmusic
mv repo/tools src/gitmusic/tools

# 2. 创建 UI 层目录
mkdir -p src/gitmusic/ui

# 3. 创建命令注册表
touch src/gitmusic/commands/registry.py
```

#### 5.1.2 实现 UI 渲染层

创建以下文件：
- `src/gitmusic/ui/renderer.py` - UIRenderer 抽象基类
- `src/gitmusic/ui/rich_renderer.py` - RichUIRenderer
- `src/gitmusic/ui/noop_renderer.py` - NoopUIRenderer
- `src/gitmusic/ui/table_registry.py` - TableStyleRegistry

#### 5.1.3 实现命令注册表

创建 `src/gitmusic/commands/registry.py`，实现：
- `CommandRegistry` 类
- `register(command)` 方法
- `discover_commands()` 方法

#### 5.1.4 迁移 CLI 入口

将 `repo/tools/cli.py` 迁移到 `src/gitmusic/cli.py`，并：
- 注入 UI 渲染器到 Context
- 使用命令注册表管理命令
- 移除直接的 Rich 调用

---

### 5.2 中期重构（2-4 周）

#### 5.2.1 添加 `pyproject.toml`

```toml
[project]
name = "gitmusic"
version = "2.0.0"
description = "Git-based audio library management system"
readme = "README.md"
license = {text = "GPL-3.0"}
requires-python = ">=3.9"
dependencies = [
    "rich>=13.0.0",
    "prompt_toolkit>=3.0.0",
    "pyyaml>=6.0",
    "mutagen>=1.45.0",
]

[project.scripts]
gitmusic = "gitmusic.cli:main"

[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"
```

#### 5.2.2 完善 CI 配置

在 `.github/workflows/` 添加：
- `lint.yml` - ruff/flake8 静态检查
- `type-check.yml` - mypy 类型检查
- `test.yml` - 单元测试和集成测试
- `build.yml` - 构建 wheel
- `release.yml` - 发布到 PyPI

#### 5.2.3 添加文档和工具

- `CHANGELOG.md` - 变更日志
- `Dockerfile` - 容器化部署
- `systemd/gitmusic.service` - systemd unit 示例
- `.pre-commit-config.yaml` - pre-commit 钩子

---

### 5.3 长期优化（1-2 月）

#### 5.3.1 完善测试覆盖

- 增加单元测试覆盖率到 80%+
- 添加 `CaptureUIRenderer` 用于 UI 测试
- 完善故障注入测试场景

#### 5.3.2 性能优化

- 分析性能瓶颈
- 优化并行处理
- 优化内存占用

#### 5.3.3 功能扩展

- Web 管理界面（FastAPI）
- 自动标签（MusicBrainz 集成）
- 插件系统
- 多后端存储（S3/MinIO）

---

## 六、迁移步骤

### 6.1 阶段一：冻结公共 API

1. **冻结 Context 接口**
   - 确定 Context 的所有字段
   - 确定 Context 的方法签名

2. **冻结 UIRenderer 接口**
   - 定义 `render_table`, `render_progress`, `render_event`, `render_panel`, `flush`

3. **冻结 TableSpec 接口**
   - 定义表格样式注册机制

4. **冻结 Events 接口**
   - 确定 Event 类型和字段

---

### 6.2 阶段二：实现核心组件

1. **实现 `events.emit()` 与日志持久化**
   - 已实现 `EventEmitter`
   - 验证 JSONL 日志格式

2. **实现 `UIRenderer` 与 `TableStyleRegistry`**
   - 创建 `src/gitmusic/ui/` 目录
   - 实现抽象基类和具体实现
   - 在 CLI 初始化时注入

3. **实现 `CommandRegistry`**
   - 创建命令注册表
   - 迁移 `publish` 为首个命令模块
   - 验证命令注册和发现机制

---

### 6.3 阶段三：迁移命令

逐个迁移以下命令：
1. `publish` - 首个迁移，验证模式
2. `checkout`
3. `sync`
4. `verify`
5. `cleanup`
6. `release`
7. `analyze`
8. `download`
9. `compress_images`

每个命令迁移步骤：
1. 创建命令模块（`src/gitmusic/commands/<name>.py`）
2. 实现 `register(registry)` 或 `Command` 实例
3. 实现 `add_arguments(parser)` 与 `run(ctx, args)`
4. 更新 `command-spec.md`
5. 添加单元测试
6. 运行回归测试

---

### 6.4 阶段四：全量回归

1. **单元测试**
   ```bash
   pytest tests/unit/ -v --cov=src/gitmusic --cov-report=html
   ```

2. **集成测试**
   ```bash
   pytest tests/integration/ -v
   ```

3. **性能测试**
   ```bash
   pytest tests/integration/test_performance.py -v
   ```

4. **故障注入测试**
   ```bash
   pytest tests/integration/test_failure_injection.py -v
   ```

5. **验收测试**
   - interactive 模式渲染美观
   - log-only 模式输出 JSONL
   - metadata 写入原子
   - 远端校验通过

---

## 七、交付物清单

### 7.1 短期交付物（1-2 周）

| 交付物 | 状态 | 说明 |
|--------|------|------|
| `src/gitmusic/ui/renderer.py` | ❌ 待实现 | UIRenderer 抽象基类 |
| `src/gitmusic/ui/rich_renderer.py` | ❌ 待实现 | RichUIRenderer |
| `src/gitmusic/ui/noop_renderer.py` | ❌ 待实现 | NoopUIRenderer |
| `src/gitmusic/ui/table_registry.py` | ❌ 待实现 | TableStyleRegistry |
| `src/gitmusic/commands/registry.py` | ❌ 待实现 | CommandRegistry |
| `src/gitmusic/cli.py` | ❌ 待迁移 | CLI 入口（从 `repo/tools/cli.py` 迁移） |
| 目录结构调整 | ❌ 待执行 | `repo/libgitmusic/` → `src/gitmusic/` |

### 7.2 中期交付物（2-4 周）

| 交付物 | 状态 | 说明 |
|--------|------|------|
| `pyproject.toml` | ❌ 待创建 | PEP 621 项目配置 |
| `.github/workflows/lint.yml` | ❌ 待创建 | 静态检查 CI |
| `.github/workflows/type-check.yml` | ❌ 待创建 | 类型检查 CI |
| `.github/workflows/test.yml` | ❌ 待创建 | 测试 CI |
| `.github/workflows/build.yml` | ❌ 待创建 | 构建 CI |
| `.github/workflows/release.yml` | ❌ 待创建 | 发布 CI |
| `CHANGELOG.md` | ❌ 待创建 | 变更日志 |
| `Dockerfile` | ❌ 待创建 | 容器化部署 |
| `systemd/gitmusic.service` | ❌ 待创建 | systemd unit |
| `.pre-commit-config.yaml` | ❌ 待创建 | pre-commit 钩子 |

### 7.3 长期交付物（1-2 月）

| 交付物 | 状态 | 说明 |
|--------|------|------|
| `CaptureUIRenderer` | ❌ 待实现 | 测试用渲染器 |
| 单元测试覆盖率 80%+ | ❌ 待提升 | 当前覆盖率未知 |
| Web 管理界面 | ❌ 待实现 | FastAPI |
| 插件系统 | ❌ 待实现 | 支持自定义处理器 |
| 多后端存储 | ❌ 待实现 | S3/MinIO 支持 |

---

## 八、风险评估

### 8.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| UI 渲染层重构影响现有功能 | 高 | 中 | 先实现抽象层，再逐步迁移 |
| 命令注册表重构影响命令调用 | 高 | 中 | 保持向后兼容，逐步迁移 |
| 目录结构调整影响导入路径 | 中 | 高 | 使用 `__init__.py` 重导出 |
| `pyproject.toml` 迁移影响依赖管理 | 中 | 低 | 保持 requirements.txt 同步 |

### 8.2 时间风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 重构时间超出预期 | 高 | 中 | 分阶段实施，每个阶段可独立交付 |
| 测试用例需要大量补充 | 中 | 高 | 优先保证核心功能测试 |
| 文档更新滞后 | 低 | 高 | 文档与代码同步更新 |

---

## 九、建议优先级

### 9.1 P0 - 必须立即解决

1. **实现 UI 渲染层** - 解决架构分层问题
2. **实现命令注册表** - 解决单一真相问题
3. **创建 `pyproject.toml`** - 解决包分发问题
4. **调整目录结构** - 解决命名空间问题

### 9.2 P1 - 建议尽快解决

1. **添加 `CHANGELOG.md`** - 符合开源规范
2. **完善 CI 配置** - 保证代码质量
3. **添加 pre-commit 钩子** - 统一代码风格
4. **完善测试覆盖** - 保证功能稳定

### 9.3 P2 - 可选优化

1. **添加 Dockerfile** - 便于部署
2. **添加 systemd unit** - 便于服务器部署
3. **完善文档** - 提高可维护性
4. **性能优化** - 提升用户体验

---

## 十、结论

### 10.1 当前状态评估

GitMusic v2.0 已经是一个**生产就绪**的项目，核心功能完整，架构清晰，文档齐全。但是，与 `doc/new/6目录结构与开源配置规范.md` 相比，存在以下主要差距：

1. **架构分层不完整**：缺少独立的 UI 渲染层
2. **目录结构不符**：代码在 `repo/libgitmusic/` 而非 `src/gitmusic/`
3. **缺少命令注册表**：命令直接导入，不符合 "单一真相" 原则
4. **缺少打包配置**：没有 `pyproject.toml`，无法通过 pip 安装

### 10.2 重构价值

重构的主要价值在于：

1. **提高可维护性**：清晰的分层架构便于理解和修改
2. **便于贡献**：符合开源项目规范，降低贡献门槛
3. **提高可测试性**：独立的 UI 层便于单元测试
4. **便于分发**：通过 `pyproject.toml` 支持 pip 安装

### 10.3 实施建议

建议采用**分阶段重构**策略：

1. **短期（1-2 周）**：实现 UI 渲染层和命令注册表，调整目录结构
2. **中期（2-4 周）**：添加打包配置和 CI，完善文档和工具
3. **长期（1-2 月）**：优化测试覆盖和性能，扩展功能

每个阶段都可以独立交付，降低风险。

---

## 附录

### A. 规范文档引用

- **主规范**: `doc/new/6目录结构与开源配置规范.md`
- **相关规范**:
  - `doc/new/1CLI架构规范.md`
  - `doc/new/2CLI视觉规范&库规范.md`
  - `doc/new/3命令规范.md`
  - `doc/new/4库函数职责规范.md`
  - `doc/new/5CLI命令&UI渲染技术规范.md`

### B. 当前实现文件清单

#### 核心库文件 (`repo/libgitmusic/`)
- `__init__.py` - 包初始化
- `audio.py` - 音频 I/O
- `context.py` - 运行时 Context
- `events.py` - EventEmitter
- `exceptions.py` - 自定义异常
- `git.py` - Git 操作封装
- `hash_utils.py` - 哈希计算
- `locking.py` - 分布式锁
- `metadata.py` - metadata.jsonl 管理
- `object_store.py` - 对象存储
- `results.py` - 结果类型
- `transport.py` - 传输适配器

#### 命令文件 (`repo/libgitmusic/commands/`)
- `__init__.py` - 命令包初始化
- `publish.py` - 发布命令
- `checkout.py` - 检出命令
- `sync.py` - 同步命令
- `verify.py` - 校验命令
- `cleanup.py` - 清理命令
- `release.py` - 生成命令
- `analyze.py` - 分析命令
- `download.py` - 下载命令
- `compress_images.py` - 压缩命令

#### CLI 入口 (`repo/tools/`)
- `cli.py` - CLI 主程序

#### 测试文件
- `tests/unit/` - 单元测试
- `tests/integration/` - 集成测试

---

**报告生成时间**: 2026-01-31
**报告版本**: 1.0
**审核状态**: 待审核
