# GitMusic 目录结构差距分析报告

**文档版本**: 1.0
**生成时间**: 2026-01-28
**基准规范**: doc/new/6目录结构与开源配置规范.md
**对比对象**: 当前项目结构（repo/ 目录结构）

---

## 📋 执行摘要

本报告对比当前 GitMusic 项目目录结构与 6号规范文档（`doc/new/6目录结构与开源配置规范.md`）的要求，识别差距并提供重构建议。

### 关键发现

| 维度 | 状态 | 说明 |
|------|------|------|
| **源代码位置** | ⚠️ 需重构 | 当前代码在 `repo/libgitmusic/`，规范要求 `src/gitmusic/` |
| **CLI 入口** | ⚠️ 需重构 | 当前在 `repo/tools/cli.py`，规范要求 `src/gitmusic/cli.py` |
| **核心模块** | ⚠️ 部分符合 | 已有 core/ 模块但位置不对，缺少 UI 层和抽象接口 |
| **配置文件** | ✅ 符合 | `config.example.yaml` 符合规范要求 |
| **文档结构** | ⚠️ 需整理 | 文档分散在 doc/ 和 doc/new/，需要统一 |
| **测试目录** | ✅ 符合 | `tests/` 目录结构基本符合规范 |
| **Archive 目录** | ⚠️ 需清理 | `archive/` 和 `repo/` 中的旧脚本需要归档整理 |

---

## 📊 详细差距分析

### 1. 顶层目录结构对比

#### 规范要求的目录结构
```
gitmusic/
├── pyproject.toml          # 项目构建与依赖声明
├── config.example.yaml     # 示例配置 ✅
├── README.md               # 项目说明 ✅
├── LICENSE                 # 许可证 ❌
├── gitmusic.ps1            # PowerShell 启动脚本 ✅
├── src/                    # 源代码包（规范要求）❌
│   └── gitmusic/
│       ├── cli.py          # 主入口
│       ├── commands/       # 命令模块
│       ├── core/           # 核心业务逻辑
│       ├── ui/             # UI 渲染层
│       └── exceptions.py   # 异常定义
├── docs/                   # 文档目录（规范要求）⚠️
├── tests/                  # 测试套件 ✅
├── archive/                # 归档文件 ✅
└── .github/                # GitHub 配置 ✅
```

#### 当前项目结构
```
gitmusic/
├── .github/                ✅
├── .vscode/                ⚠️ 开发配置（不应入库）
├── README.md               ✅
├── config.example.yaml     ✅
├── gitmusic.ps1            ✅
├── pytest.ini              ⚠️ 应移至 tests/ 或使用 pyproject.toml
├── test_runner.py          ⚠️ 应移至 tests/
├── assets/                 ⚠️ 静态资源（规范未明确）
├── archive/                ✅
├── doc/                    ⚠️ 文档目录（规范使用 docs/）
│   ├── archive/            # 归档文档
│   ├── new/                # 新规范文档
│   ├── OPERATION.md        # 操作手册
│   ├── command-spec.md     # 命令规范
│   └── TROUBLESHOOTING.md  # 故障排查
├── repo/                   ❌ 非规范目录（应迁移到 src/）
│   ├── libgitmusic/        # 核心库代码（应迁移到 src/gitmusic/）
│   │   ├── __init__.py
│   │   ├── context.py
│   │   ├── events.py
│   │   ├── metadata.py
│   │   ├── transport.py
│   │   ├── audio.py
│   │   ├── hash_utils.py
│   │   ├── locking.py
│   │   ├── object_store.py
│   │   ├── exceptions.py
│   │   ├── git.py
│   │   ├── results.py
│   │   └── commands/       # 命令实现（应迁移到 src/gitmusic/commands/）
│   │       ├── __init__.py
│   │       ├── publish.py
│   │       ├── checkout.py
│   │       ├── sync.py
│   │       ├── verify.py
│   │       ├── cleanup.py
│   │       ├── release.py
│   │       ├── analyze.py
│   │       ├── download.py
│   │       └── compress_images.py
│   ├── tools/              # 工具脚本（cli.py 应迁移到 src/gitmusic/cli.py）
│   │   ├── cli.py          # CLI 入口（位置错误）
│   │   ├── analyze_metadata.py
│   │   ├── download_ytdlp.py
│   │   └── analyze_duplicates.py
│   ├── data/               # 数据处理脚本（规范未明确）
│   │   ├── sync_cache.py
│   │   ├── verify_hashes.py
│   │   └── cleanup_orphaned.py
│   ├── work/               # 工作目录（不应入库，应加 .gitignore）
│   ├── cache/              # 缓存目录（不应入库，应加 .gitignore）
│   ├── release/            # 发布目录（不应入库，应加 .gitignore）
│   ├── server/             # 服务器配置（规范未明确）
│   │   ├── post-receive
│   │   ├── music-queue-handler.service
│   │   └── queue_handler.py
│   ├── metadata.jsonl      # 元数据文件（Git 跟踪，用于版本控制）
│   └── .gitignore          # Git 忽略配置
├── tests/                  ✅
│   ├── integration/        # 集成测试
│   ├── unit/               # 单元测试
│   └── conftest.py         # 测试配置
└── ...                     # 其他文件
```

---

### 2. 核心差距清单

#### 2.1 源代码位置（高优先级）

| 规范要求 | 当前状态 | 差距 | 影响 |
|---------|---------|------|------|
| `src/gitmusic/` | `repo/libgitmusic/` | 目录位置错误 | 不符合 Python 包结构规范 |
| `src/gitmusic/cli.py` | `repo/tools/cli.py` | CLI 入口位置错误 | 不符合规范的单一入口原则 |
| `src/gitmusic/core/*` | `repo/libgitmusic/` 根目录 | 模块职责不清晰 | core/ 子目录缺失 |
| `src/gitmusic/ui/*` | 完全缺失 | 缺少 UI 渲染层 | 无法实现规范要求的 RichUIRenderer |

**问题分析**：
- 当前项目将核心代码放在 `repo/libgitmusic/`，这不符合规范的 `src/gitmusic/` 结构
- CLI 入口在 `repo/tools/cli.py`，规范要求在 `src/gitmusic/cli.py`
- 缺少 UI 渲染层（`ui/renderer.py`, `ui/rich_renderer.py`, `ui/noop_renderer.py`）
- 缺少抽象接口定义（如 `UIRenderer` 抽象基类）

#### 2.2 模块职责分层（中优先级）

| 规范要求 | 当前状态 | 差距 |
|---------|---------|------|
| CLI 层 (`cli.py`) | `repo/tools/cli.py` | 位置错误，职责混杂 |
| 命令层 (`commands/*`) | `repo/libgitmusic/commands/*` | 位置错误，但实现基本符合 |
| 核心库层 (`core/*`) | `repo/libgitmusic/` 根目录 | 缺少 core/ 子目录 |
| UI 层 (`ui/*`) | 完全缺失 | 需要完整实现 |
| 异常定义 (`exceptions.py`) | `repo/libgitmusic/exceptions.py` | 位置错误 |

**当前实现的问题**：
1. `repo/tools/cli.py` 中混杂了：
   - CLI 命令解析
   - StepContext 定义
   - 命令注册表
   - 事件处理逻辑
   - Rich 渲染逻辑

   规范要求 CLI 层只负责：
   - 读取配置、构建 Context
   - 调用 commands.discover_commands()
   - 创建 argparse 子解析器
   - 订阅 events、注入 ui 渲染器
   - 分发命令执行

2. 缺少 `core/` 子目录，当前所有核心模块平铺在 `libgitmusic/` 根目录

#### 2.3 UI 渲染层（高优先级）

| 规范要求 | 当前状态 | 差距 |
|---------|---------|------|
| `ui/renderer.py` - UIRenderer 抽象基类 | ❌ 缺失 | 需要实现 |
| `ui/rich_renderer.py` - RichUIRenderer | ❌ 缺失 | 需要实现 |
| `ui/noop_renderer.py` - NoopUIRenderer | ❌ 缺失 | 需要实现 |
| `ui/table_registry.py` - TableStyleRegistry | ❌ 缺失 | 需要实现 |

**问题分析**：
- 当前 CLI 直接使用 `rich` 库进行渲染（`repo/tools/cli.py` 第 11-27 行）
- 没有抽象的 `UIRenderer` 接口
- 没有 `TableStyleRegistry` 集中管理表格样式
- 命令层直接调用 `ctx.ui` 的方法（规范要求），但当前实现是 CLI 直接渲染

#### 2.4 配置与路径管理（中优先级）

| 规范要求 | 当前状态 | 差距 |
|---------|---------|------|
| `config.example.yaml` | ✅ 存在 | 符合规范 |
| `Context` 类 | `repo/libgitmusic/context.py` | 位置错误，但实现基本符合 |
| 环境变量 `GITMUSIC_CONFIG` | ✅ 支持 | `create_context()` 函数支持 |
| 路径解析为绝对路径 | ✅ 支持 | `Context.__post_init__()` 实现 |

**当前实现的优点**：
- `Context` 类实现了路径管理、临时文件跟踪、清理等功能
- `create_context()` 函数支持环境变量和默认位置查找
- 配置合并逻辑正确（默认配置 + 用户配置）

**需要改进的地方**：
- `Context` 类应在 `src/gitmusic/core/context.py`（规范要求）
- 缺少 `UIRenderer` 的注入（规范要求 CLI 注入 ui 渲染器）

#### 2.5 文档结构（中优先级）

| 规范要求 | 当前状态 | 差距 |
|---------|---------|------|
| `docs/` 目录 | `doc/` 目录 | 目录名不一致（规范用 docs/） |
| 命令规范 | `doc/command-spec.md` ✅ | 内容完整 |
| 操作手册 | `doc/OPERATION.md` ✅ | 内容完整 |
| 故障排查 | `doc/TROUBLESHOOTING.md` ✅ | 内容完整 |
| 新规范文档 | `doc/new/` ✅ | 存在 1-6 号文档 |

**问题分析**：
- 目录名 `doc/` 与规范 `docs/` 不一致
- `doc/new/` 中的规范文档需要整合到 `docs/` 目录
- 缺少 `CHANGELOG.md`（规范要求发布时更新）

#### 2.6 测试目录（基本符合）

| 规范要求 | 当前状态 | 差距 |
|---------|---------|------|
| `tests/` 目录 | ✅ 存在 | 符合规范 |
| 单元测试 | `tests/unit/` ✅ | 符合规范 |
| 集成测试 | `tests/integration/` ✅ | 符合规范 |
| `conftest.py` | `tests/conftest.py` ✅ | 符合规范 |

**当前实现的优点**：
- 测试目录结构清晰
- 有完整的单元测试和集成测试
- `conftest.py` 提供测试桩和 mock

**需要改进的地方**：
- `pytest.ini` 应使用 `pyproject.toml` 配置（推荐方案，避免配置分散）
- `test_runner.py` 应移至 `tests/` 目录

#### 2.7 Archive 目录（基本符合）

| 规范要求 | 当前状态 | 差距 |
|---------|---------|------|
| `archive/` 目录 | ✅ 存在 | 符合规范 |
| 废弃脚本归档 | `archive/` ✅ | 部分归档 |
| 历史文档 | `doc/archive/` ✅ | 部分归档 |

**问题分析**：
- `repo/tools/` 中的旧脚本（`analyze_metadata.py`, `download_ytdlp.py`, `analyze_duplicates.py`）应移至 `archive/`
- `repo/data/` 中的脚本应移至 `archive/` 或重构到 `src/gitmusic/core/`
- `repo/server/` 中的服务器配置需要整理

---

### 3. 配置文件差距分析

#### 3.1 `config.example.yaml` 对比

| 配置项 | 规范要求 | 当前状态 | 差距 |
|--------|---------|---------|------|
| `transport.user` | ✅ SSH 用户名 | ✅ 存在 | 符合 |
| `transport.host` | ✅ 服务器地址 | ✅ 存在 | 符合 |
| `transport.remote_data_root` | ✅ 远程数据目录 | ✅ 存在 | 符合 |
| `transport.retries` | ✅ 重试次数 | ✅ 存在 | 符合 |
| `transport.timeout` | ✅ 超时时间 | ✅ 存在 | 符合 |
| `transport.workers` | ✅ 并行线程数 | ✅ 存在 | 符合 |
| `paths.work_dir` | ✅ 工作目录 | ✅ 存在 | 符合 |
| `paths.cache_root` | ✅ 缓存根目录 | ✅ 存在 | 符合 |
| `paths.metadata_file` | ✅ 元数据文件 | ✅ 存在 | 符合 |
| `paths.release_dir` | ✅ 发布目录 | ✅ 存在 | 符合 |
| `paths.logs_dir` | ✅ 日志目录 | ✅ 存在 | 符合 |
| `image.quality` | ✅ 图像质量 | ✅ 存在 | 符合 |
| `command_defaults` | ✅ 命令默认行为 | ✅ 存在 | 符合 |

**结论**：配置文件基本符合规范要求。

---

### 4. 代码实现差距分析

#### 4.1 CLI 入口 (`repo/tools/cli.py`)

**规范要求**：
- `src/gitmusic/cli.py` 作为主入口
- 职责：读取配置、构建 Context、调用 commands.discover_commands()、创建 argparse 子解析器、订阅 events、注入 ui 渲染器、分发命令执行

**当前实现**：
- 位置：`repo/tools/cli.py` ❌
- 职责混杂：包含 StepContext、Command、GitMusicCLI 等大量实现逻辑
- 直接使用 Rich 进行渲染，没有抽象 UI 层

**差距**：
1. 位置错误（应在 `src/gitmusic/cli.py`）
2. 职责过重：CLI 层不应包含命令实现逻辑
3. 缺少 UI 抽象：直接调用 Rich，没有 UIRenderer 接口
4. 缺少命令注册表：规范要求 `commands.discover_commands()`

#### 4.2 命令实现 (`repo/libgitmusic/commands/*`)

**规范要求**：
- 每个命令一个模块（`publish.py`, `checkout.py` 等）
- 导出 `register(registry)` 或 `Command` 实例
- 包含 `add_arguments(parser)` 与 `run(ctx, args)`
- 命令模块只做参数映射与步骤组合

**当前实现**：
- 位置：`repo/libgitmusic/commands/*` ❌（应在 `src/gitmusic/commands/`）
- 实现方式：导出 `logic()` 和 `execute()` 函数
- 缺少 `register()`、`add_arguments()`、`run()` 接口

**差距**：
1. 位置错误
2. 接口不一致：当前使用 `publish_logic()` 和 `execute_publish()`，规范要求 `register()`、`add_arguments()`、`run()`
3. 缺少命令注册表机制

#### 4.3 核心库层 (`repo/libgitmusic/`)

**规范要求**：
- `core/object_store.py` - 本地 cache 管理
- `core/metadata.py` - metadata.jsonl 管理
- `core/transport.py` - 远端传输抽象
- `core/locking.py` - 文件/进程锁
- `core/audio.py` - 音频 I/O
- `core/hash_utils.py` - 哈希计算
- `core/git.py` - git 操作封装
- `core/context.py` - 运行时 Context
- `core/events.py` - EventEmitter

**当前实现**：
- `repo/libgitmusic/object_store.py` ✅（位置错误）
- `repo/libgitmusic/metadata.py` ✅（位置错误）
- `repo/libgitmusic/transport.py` ✅（位置错误）
- `repo/libgitmusic/locking.py` ✅（位置错误）
- `repo/libgitmusic/audio.py` ✅（位置错误）
- `repo/libgitmusic/hash_utils.py` ✅（位置错误）
- `repo/libgitmusic/git.py` ✅（位置错误）
- `repo/libgitmusic/context.py` ✅（位置错误）
- `repo/libgitmusic/events.py` ✅（位置错误）

**差距**：
1. 所有模块位置错误（应在 `src/gitmusic/core/`）
2. 缺少 `core/` 子目录结构

---

### 5. 事件系统差距分析

#### 规范要求
- `core/events.py` - EventEmitter，负责写 JSONL 日志
- 事件类型：PhaseEvent、ItemEvent、ProgressEvent、ErrorEvent、ResultEvent
- 日志格式：每行 JSON 包含 `ts`、`cmd`、`type`、`phase`、`id`、`status`、`message`、`artifacts`

#### 当前实现
- `repo/libgitmusic/events.py` ✅（位置错误）
- 实现了 `EventEmitter` 类
- 支持 JSONL 日志写入
- 支持事件监听器

#### 差距
1. 位置错误（应在 `src/gitmusic/core/events.py`）
2. 事件类型定义不够清晰（缺少明确的 Event 类）
3. 日志格式基本符合规范

---

### 6. UI 渲染层差距分析（完全缺失）

#### 规范要求
- `ui/renderer.py` - `UIRenderer` 抽象基类
  - `render_table()`
  - `render_progress()`
  - `render_event()`
  - `render_panel()`
  - `flush()`
- `ui/rich_renderer.py` - `RichUIRenderer`，使用 `rich` 渲染
- `ui/noop_renderer.py` - `NoopUIRenderer`，log-only 模式
- `ui/table_registry.py` - `TableStyleRegistry`，集中注册表格样式

#### 当前实现
- ❌ 完全缺失

#### 差距
1. 没有 `UIRenderer` 抽象基类
2. 没有 `RichUIRenderer` 实现
3. 没有 `NoopUIRenderer` 实现
4. 没有 `TableStyleRegistry`
5. CLI 直接使用 Rich 进行渲染，违反了规范的分层原则

---

### 7. 打包与发布差距分析

#### 规范要求
- `pyproject.toml` - 使用 PEP 621 声明包名和入口点
- `console_scripts = gitmusic=gitmusic.cli:main`
- CI 流程：静态检查、类型检查、单元测试、集成测试、构建 wheel、发布到 PyPI

#### 当前实现
- ❌ 缺少 `pyproject.toml`
- ❌ 缺少 `setup.py` 或 `setup.cfg`
- ❌ 缺少 `requirements.txt`（README 中提到但未找到）
- ❌ 缺少 CI 配置（`.github/` 中可能有但未检查）

#### 差距
1. 缺少 `pyproject.toml`（高优先级）
2. 缺少依赖声明文件
3. 缺少打包配置

---

## 🎯 重构建议

### 阶段 1：目录结构重构（高优先级）

#### 1.1 创建标准目录结构
```bash
# 创建 src 目录
mkdir -p src/gitmusic/{commands,core,ui}

# 移动核心代码
mv repo/libgitmusic/* src/gitmusic/

# 移动 CLI 入口
mv repo/tools/cli.py src/gitmusic/cli.py

# 更新导入路径
# 需要修改所有文件的导入语句
```

#### 1.2 更新导入路径
需要修改的文件：
- `src/gitmusic/cli.py` - 更新所有导入
- `src/gitmusic/commands/*.py` - 更新导入路径
- `src/gitmusic/core/*.py` - 更新导入路径
- `tests/` 中的测试文件 - 更新导入路径

### 阶段 2：实现 UI 渲染层（中优先级）

#### 2.1 创建 UI 抽象接口
```python
# src/gitmusic/ui/renderer.py
from abc import ABC, abstractmethod

class UIRenderer(ABC):
    @abstractmethod
    def render_table(self, table_spec, data): ...

    @abstractmethod
    def render_progress(self, current, total, message): ...

    @abstractmethod
    def render_event(self, event): ...

    @abstractmethod
    def render_panel(self, title, content): ...

    @abstractmethod
    def flush(self): ...
```

#### 2.2 实现 RichUIRenderer
```python
# src/gitmusic/ui/rich_renderer.py
from rich.console import Console
from rich.progress import Progress
from rich.table import Table
from .renderer import UIRenderer

class RichUIRenderer(UIRenderer):
    def __init__(self):
        self.console = Console()

    def render_table(self, table_spec, data):
        # 使用 rich 渲染表格
        pass
    # ... 其他方法
```

#### 2.3 实现 NoopUIRenderer
```python
# src/gitmusic/ui/noop_renderer.py
from .renderer import UIRenderer

class NoopUIRenderer(UIRenderer):
    """log-only 模式下的渲染器，不输出任何内容"""
    def render_table(self, table_spec, data):
        pass
    # ... 其他方法
```

#### 2.4 实现 TableStyleRegistry
```python
# src/gitmusic/ui/table_registry.py
class TableStyleRegistry:
    """集中管理表格样式定义"""
    def __init__(self):
        self._styles = {}

    def register(self, style_id, table_spec):
        self._styles[style_id] = table_spec

    def get(self, style_id):
        return self._styles.get(style_id)
```

### 阶段 3：重构 CLI 层（高优先级）

#### 3.1 简化 CLI 职责
```python
# src/gitmusic/cli.py
def main():
    # 1. 读取配置，构建 Context
    ctx = create_context()

    # 2. 创建命令注册表
    registry = CommandRegistry()

    # 3. 发现并注册命令
    discover_commands(registry)

    # 4. 创建 argparse 子解析器
    parser = create_argparse_parser(registry)

    # 5. 解析参数
    args = parser.parse_args()

    # 6. 注入 UI 渲染器
    ui_renderer = create_ui_renderer(ctx.mode)

    # 7. 分发命令执行
    command = registry.get(args.command)
    command.run(ctx, args)
```

#### 3.2 创建命令注册表
```python
# src/gitmusic/commands/registry.py
class CommandRegistry:
    def __init__(self):
        self._commands = {}

    def register(self, name, command):
        self._commands[name] = command

    def get(self, name):
        return self._commands.get(name)

    def discover_commands(self):
        # 自动发现 commands/ 目录下的所有命令模块
        pass
```

### 阶段 4：重构命令实现（中优先级）

#### 4.1 统一命令接口
```python
# src/gitmusic/commands/publish.py
class PublishCommand:
    def add_arguments(self, parser):
        parser.add_argument("--preview", action="store_true")
        parser.add_argument("--changed-only", action="store_true")

    def run(self, ctx, args):
        # 参数映射
        params = self._map_args(args)

        # 调用 core API
        result = publish_core(ctx, params)

        # 渲染结果
        ctx.ui.render_result(result)
```

#### 4.2 注册命令
```python
# src/gitmusic/commands/__init__.py
from .publish import PublishCommand
from .checkout import CheckoutCommand
# ...

def register_commands(registry):
    registry.register("publish", PublishCommand())
    registry.register("checkout", CheckoutCommand())
    # ...
```

### 阶段 5：创建 pyproject.toml（高优先级）

```toml
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "gitmusic"
version = "2.0.0"
description = "基于Git对象存储的音频库管理系统"
readme = "README.md"
requires-python = ">=3.9"
license = {text = "MIT"}
dependencies = [
    "rich>=13.0.0",
    "pyyaml>=6.0",
    "mutagen>=1.45.0",
    "prompt_toolkit>=3.0.0",
    "pygments>=2.10.0",
    "send2trash>=1.8.0",
]

[project.scripts]
gitmusic = "gitmusic.cli:main"

[tool.setuptools.packages.find]
where = ["src"]
include = ["gitmusic*"]

[tool.pytest.ini_options]
testpaths = ["tests"]
pythonpath = ["src"]
```

### 阶段 6：整理文档目录（中优先级）

```bash
# 重命名 doc/ 为 docs/
mv doc/ docs/

# 移动新规范文档到 docs/
mv docs/new/* docs/

# 清理归档文档
mv docs/archive/* docs/archive/
```

### 阶段 7：清理 .gitignore（中优先级）

确保以下内容在 `.gitignore` 中：
```
# 运行时目录
/work/
/cache/
/release/
/logs/

# 开发配置
.vscode/
.idea/

# Python
__pycache__/
*.pyc
.venv/
venv/

# 测试
.pytest_cache/
.coverage
htmlcov/
```

**注意**：`metadata.jsonl` 不应被忽略，因为它是项目的核心元数据文件，需要通过 Git 进行版本控制。

---

## 📋 重构任务清单

### 高优先级（必须完成）

| 任务 | 说明 | 预计工时 | 依赖 |
|------|------|---------|------|
| T1 | 创建 `src/` 目录结构 | 0.5h | - |
| T2 | 移动 `repo/libgitmusic/` 到 `src/gitmusic/` | 1h | T1 |
| T3 | 移动 `repo/tools/cli.py` 到 `src/gitmusic/cli.py` | 0.5h | T1 |
| T4 | 更新所有导入路径 | 2h | T2, T3 |
| T5 | 创建 `pyproject.toml` | 1h | - |
| T6 | 实现 `ui/renderer.py` (UIRenderer 抽象) | 1.5h | - |
| T7 | 实现 `ui/rich_renderer.py` (RichUIRenderer) | 2h | T6 |
| T8 | 实现 `ui/noop_renderer.py` (NoopUIRenderer) | 1h | T6 |
| T9 | 重构 CLI 层，简化职责 | 3h | T7, T8 |
| T10 | 更新测试文件导入路径 | 1h | T4 |

**小计**：13.5 小时

### 中优先级（推荐完成）

| 任务 | 说明 | 预计工时 | 依赖 |
|------|------|---------|------|
| T11 | 实现 `ui/table_registry.py` | 1h | T6 |
| T12 | 创建命令注册表机制 | 1.5h | T9 |
| T13 | 统一命令接口 (`add_arguments`, `run`) | 3h | T12 |
| T14 | 整理文档目录 (`doc/` → `docs/`) | 0.5h | - |
| T15 | 清理 `.gitignore` | 0.5h | - |
| T16 | 移动旧脚本到 `archive/` | 1h | - |
| T17 | 更新 README 中的目录结构说明 | 1h | T1-T16 |

**小计**：8.5 小时

### 低优先级（可选）

| 任务 | 说明 | 预计工时 | 依赖 |
|------|------|---------|------|
| T18 | 添加 CI 配置 (GitHub Actions) | 3h | T5 |
| T19 | 添加 pre-commit 钩子 | 1h | - |
| T20 | 添加类型检查 (mypy) | 2h | T4 |
| T21 | 创建 CHANGELOG.md | 0.5h | - |
| T22 | 添加 LICENSE 文件 | 0.25h | - |

**小计**：6.75 小时

**总计**：28.75 小时

---

## 📊 差距总结表

| 类别 | 符合项 | 部分符合项 | 缺失项 | 总计 |
|------|--------|-----------|--------|------|
| 目录结构 | 4 | 3 | 4 | 11 |
| 源代码位置 | 0 | 0 | 5 | 5 |
| 模块职责 | 0 | 2 | 3 | 5 |
| UI 渲染层 | 0 | 0 | 4 | 4 |
| 配置文件 | 2 | 0 | 0 | 2 |
| 文档结构 | 3 | 2 | 1 | 6 |
| 测试目录 | 4 | 1 | 0 | 5 |
| 打包发布 | 0 | 0 | 3 | 3 |
| **总计** | **13** | **8** | **20** | **41** |

**符合率**：31.7% (13/41)
**部分符合率**：19.5% (8/41)
**缺失率**：48.8% (20/41)

---

## 🎯 结论与建议

### 主要问题
1. **目录结构不符合规范**：代码在 `repo/` 而非 `src/`
2. **缺少 UI 渲染层**：完全缺失抽象接口和实现
3. **CLI 职责过重**：混杂了命令实现逻辑
4. **缺少打包配置**：没有 `pyproject.toml`

### 建议优先级
1. **立即执行**：创建 `src/` 目录，移动代码，更新导入
2. **短期完成**：实现 UI 渲染层，重构 CLI
3. **中期完成**：统一命令接口，整理文档
4. **长期优化**：添加 CI/CD，完善测试覆盖

### 风险评估
- **高风险**：目录结构重构可能影响现有功能
- **中风险**：UI 层实现需要与现有渲染逻辑兼容
- **低风险**：文档整理不影响代码功能

### 建议的执行顺序
1. 创建新目录结构（不影响现有代码）
2. 逐步迁移代码到新位置（保持向后兼容）
3. 实现 UI 抽象层（不影响现有功能）
4. 重构 CLI（逐步替换现有实现）
5. 更新测试（确保重构后功能正常）
6. 清理旧代码（删除 `repo/` 目录）

---

## 📝 附录

### A. 规范文档位置
- 主规范：`doc/new/6目录结构与开源配置规范.md`
- 其他规范：
  - `doc/new/1CLI架构规范.md`
  - `doc/new/2CLI视觉规范&库规范.md`
  - `doc/new/3命令规范.md`
  - `doc/new/4库函数职责规范.md`
  - `doc/new/5CLI命令&UI渲染技术规范.md`

### B. 当前项目关键文件清单
- `repo/libgitmusic/context.py` - Context 实现
- `repo/libgitmusic/events.py` - EventEmitter 实现
- `repo/libgitmusic/metadata.py` - MetadataManager 实现
- `repo/libgitmusic/object_store.py` - ObjectStore 实现
- `repo/libgitmusic/transport.py` - TransportAdapter 实现
- `repo/tools/cli.py` - CLI 入口（主要实现）
- `config.example.yaml` - 配置文件示例
- `README.md` - 项目文档

### C. 参考资料
- 规范文档：`doc/new/6目录结构与开源配置规范.md`
- README：`README.md`
- 操作手册：`doc/OPERATION.md`
- 命令规范：`doc/command-spec.md`

---

**报告生成时间**：2026-01-28
**报告版本**：1.0
**审核状态**：待审核
